---
title: "Yocto"
date: 2025-10-01 20:25:24 +0800
categories: [Linux]
tags: [Linux]
---

# Yocto Learning Roadmap

## 📌 Giới thiệu
Tài liệu này được viết để tổng hợp lộ trình học và thực hành với **Yocto Project** – một framework mạnh mẽ để build Linux nhúng.  
Mục tiêu: từ kiến thức nền tảng → làm chủ Yocto → build image cho thiết bị nhúng thực tế.

---

## 🧩 1. Nền tảng trước khi học Yocto
### 1. Linux cơ bản
#### 1.1 `ls` (liệt kê file/ thư mục)
```bash
ls /
```
Result:
```bash
bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  
root  run  sbin  srv  sys  tmp  usr  var
```
- **bin**: Chứa các lệnh cơ bản cho người dùng
**VD**: `ls`, `cp`, `mv`, `cat`, `echo`.

- **sbin**: Chức các lệnh quản trị hệ thống, thương cần quyền root.
**VD**: `ifconfig`, `reboot`, `mount`.

- **lib và lib64**: Chứa thư viện hệ thống cần thiết cho chương trình trong `/bin` và `/sbin`.
**VD**: Thư viện `.so` (shared project)
`lib64` dành riêng cho hệ thống 64-bit.

**boot**: Chứa file khởi động hệ thống: kernel (vmlinuz), initrd và bootloader (GRUB).

**dev**: Đại diện cho thiết bị phần cứng dưới dạng file.
**VD**: `/dev/sda`(ổ cứng), `/dev/ttyUSB0` (serial), `/dev/null`.

**proc**: Thư mục ảo, chứa thông tin về tiến trình và kernel.
**VD**: `proc/cpuinfo`, `/proc/meminfo`, `/proc/[pid]`.

**sys**: Cung cấp thông tin về thiết bị và driver. Dùng nhiều trong debug kernel.

**home**: Chứa thư mục cá nhân của từng user.
**VD**: `/home/user1`, `/home/user2`.

**root**: Thư mục cá nhân của tài khoản root (superuser).

**tmp**: Chứa file tạm thời. Bị xóa khi khởi động lại.

**media**: Thư mục mount tự động cho thiết bị ngoài.
**VD**: Khi cắm USB vào sẽ hiện `/media/username/USB_DRIVE`.

**etc**: Chứa file cấu hình hệ thống.
**VD**: `/etc/passwd`, `/etc/fstab`, `/etc/hostname`.

**srv**: Chứa dữ liệu cho các dịch vụ server.
**VD**: `/srv/ftp`, `/srv/www`.

**run**: Lưu thông tin runtime (PID file, socket, lock). Được reset khi khởi động lại.

**usr**: Chứ phần mềm và thư viện cho người dùng. Bên trong có `/usb/bin` (lệnh của user), `/usr/sbin` (lệnh quản trị user), `/user/lib` (thư viện), `/usr/share` (dữ liệu dùng chung, ví dụ tài liệu, icons).

**var**: Chứa dữ liệu thay đổi thường xuyên.
**VD**: `/var/log` (log hệ thống), `/var/lib` (database tạm), `/var/cache`.

#### 1.2 `pwd` (in thư mục hiện tại)
```bash
pwd
```
Result:

```bash
/home/username
```

#### 1.3 `cd` (di chuyển thư mục)
```bash
cd /etc
pwd
```
Result:
```bash
/etc
```

#### 1.4 `mkdir` (tạo thư mục)
```bash
mkdir test_dir
ls
```
Result:
```bash
mkdir test_dir
ls
```

#### 1.5 `touch` (tạo file rỗng)
```bash
touch test.txt
ls
```

#### 1.6 `cp` (copy file)

## 🚀 2. Bắt đầu với Yocto
`Yocto Project` giúp giải quyết một số vấn đề chính trong phát triển hệ điều hành cho thiết bị nhúng:
- **Tính linh hoạt:** Yocto cho phép tùy chỉnh từ bootloader, kernel đến user space, từ đó dễ dàng tạo ra hệ điều hành phù hợp cho các thiết bị có yêu cầu phần cứng riêng biệt.
- **Tái sử dụng mã nguồn:** Yocto hỗ trợ việc tái sử dụng các thành phần từ các dự án mã nguồn mở, giúp tiết kiệm thời gian và chi phí phát triển.
- **Khả năng mô đun hóa:** Với các meta-layer và recipe, Yocto giúp quản lý, mở rộng và phát triển hệ thống một cách hiệu quả, tách biệt các thành phần theo từng lớp chức năng.
- **Khả năng tích hợp CI/CD:** Yocto có thể tích hợp với các hệ thống Continuous Integration/Continuous Deployment (CI/CD) để giúp tự động hóa và kiểm tra quá trình xây dựng hệ điều hành.

Các dự án và công cụ chính cấu thành nên sinh thái xây dựng Yocto Project bao gồm: Poky, BitBake và OpenEmbedded Core.
### 🏗️ Poky
Là bản phần phối mặc định của Yocto Project, nó dùng công nghệ hệ thống xây dừng OpenEmbedded. Nó bao gồm các tools, file cấu hình và recipe data (như là metadata). Poky độc lập với nền tảng và thực iện biên dịch chéo (cross-compiling) bằng công cụ Bitbake, OpenEmbedded Core và metadata mặc định.

Là 1 git repository được tập hợp từ nhiều git repositories: bitbake, openembedded-core, yocto-docs và meta-yocto.
![alt text](/assets/Linux/Yocto/image-15.png)

poky cũng là bản reference Distro (distribution) do Yocto cung cấp.
Meta-poky là layer cung cấp bản phân phối tham chiếu poky.

##### 🔨 BitBake
Là 1 task scheduler và thực thi hệ thống (execution system). Nó được mô tả giống `GNU Make`.
Nó phân tích text file biết cái nó build cái nào và như thế nào. Nó được viết bằng Python (Cần Python 3). Bitbake là công cụ chính của Yocto, Recipe là loại file chính mà BitBake đọc đuôi (.bb).

Hình mô tả dependency giữa các recipe:
![alt text](/assets/Linux/Yocto/image-16.png)

### 🎯 OpenEmbedded Core
OpenEmbedded là framework cơ bản mà Yocto Project sử dụng. OpenEmbedded cung cấp môi trường và cấu trúc để tạo ra hệ điều hành nhúng, cho phép người dùng dễ dàng xây dựng và quản lý các thành phần phần mềm trong hệ điều hành của họ.

Là core layer, tất cả các layer được xây dựng từ openembedded-core.

`Công cụ:` OpenEmbedded cung cấp các meta-layers, recipes, và các công cụ bổ sung giúp Yocto Project linh hoạt và mạnh mẽ hơn.

### 📄 Metadata
Input của `bitbake` thì gọi là metadata. Metadata bao gồm configuration files, recipes, classes và include files. Metadata được tổ chức thành nhiều lớp, đa dạng những thành phần.
- Mỗi layer được set gồm những recipes, configuration files phục vụ chung mục đích.
#### Config File (`.conf`)
Định nghĩa nội dung toàn cục (global content) để cung cấp thông tin và cấu hình cách các **recipes** và lớp **classes** hoạt động. 
**Ví dụ:** điển hình là tệp máy (machine file), mô tả các cài đặt phần cứng.
- `local.conf:` Chứa các thiết lập liên quan đến máy đích, số luồng CPU để build, v.v.
- `bblayers.conf:` Xác định các layer mà BitBake sẽ sử dụng trong quá trình build.

#### Recipe (`.bb` và `.bbappend`)
**Recipe** là các tệp tin mô tả cách biên dịch và cài đặt một gói phần mềm trong Yocto Project. Mỗi recipe chứa các hướng dẫn như:
- Nguồn mã nguồn (SRC_URI).
- Cách biên dịch (do_compile).
- Cách cài đặt (do_install).
Các recipe có phần mở rộng `.bb` và là thành phần quan trọng giúp **BitBake** hiểu cách biên dịch một phần mềm.

#### Class (`.bbclass`)
Class (các tệp .bbclass) chứa các đoạn mã dùng chung để sử dụng trong nhiều recipe khác nhau. Thay vì lặp lại mã trong từng recipe, bạn có thể đặt các hành động chung trong một class.
**Ví dụ:** autotools.bbclass cung cấp các lệnh cần thiết để biên dịch phần mềm dùng công cụ autotools.

Ví `Poky` như nhà hàng thì, `bitbake` làm đầu bếp xào nấu theo các công thức là `metadata` ra các file image mình cần.

#### Package
**Package** là kết quả đầu ra của quá trình biên dịch trong Yocto. Mỗi package chứa các tệp thực thi, thư viện, hoặc dữ liệu cần thiết để cài đặt và sử dụng phần mềm trên hệ thống đích. BitBake sẽ tạo ra các package này dưới dạng .ipk, .deb, hoặc .rpm dựa trên cấu hình.


## 🔧 3. Poky 
- `bitbake/` Chứa tất cả các script dùng cho lệnh `bitbake`.
- `documentation/` chưa tài liệu yocto project.
- `meta/` chứa `metadate` của **OpenEmbedded-Core**.
- `meta-skeleton/`: Chứa mẫu recipes của BSP và Kernel Development.
- `meta-poky/`: Chứa cấu hình cho bản Poky distro.
- `meta-yocto-bsp/`: Chứa cấu hình BSP cho hardware board.
- `LICENSE` File giấy phép (license) mà Poky được phân phối theo, gồm sự kết hợp giữa GPLv2 và MIT.
- `oe-init-build-env`: Script để thiết lập môi trường build OpenEmbedded. Khi chạy script này, nó sẽ tạo thư mục build.
- `scripts/`: Chứa các script để setup environment, development tools và công cụ flash (nạp) các image đã build vào thiết bị đích (target).


## 🛠 4. Yocto Project Workflow
![alt text](/assets/Linux/Yocto/image-18.png)
### 1. 📥 Source Fetching
![alt text](/assets/Linux/Yocto/image-19.png)
Tải source xuống trên server và giải nén.
**do fetch**
**do_unpack**

### 2. 🔧 Patching (Bản vá)
![alt text](/assets/Linux/Yocto/image-20.png)
Sau khi tải xong thì yocto sử dụng các bản vá thông qua biến file `.patch` hoặc `.diff`.
**do_patch**

### 3. ⚙️ Configuration and Compilation
![alt text](/assets/Linux/Yocto/image-21.png)
`$ source oe-init-build-env [build_dir]`
`$ build_dir> bitbake <target>`
Sau khi patch xong thực hiện việc cấu hình.
**do_configure**
**do_compile**
**do_install**

### 4. 💿 Image Generation
![alt text](/assets/Linux/Yocto/image-22.png)
build ra rootfs sau khi xong thực hiện ra image
**do_rootfs**
**do_image**

## 🔄 Các bước build
### 1. 💻 Chuẩn bị bên máy host (PC ubuntu)
Ubuntu 20 thì không sao, nhưng đổ lên thì bị cấp quyền mới build được. Nên hỏi chatgpt.

```bash
sudo apt-get install gawk wget git-core diffstat unzip texinfo gcc-multilib \
     build-essential chrpath socat cpio python3 python3-pip python3-pexpect \
     libsdl1.2-dev xterm make xsltproc docbook-utils fop dblatex xmlto
```
### 📦 Clone source code 
```bash
git clone -b kirkstone git://git.yoctoproject.org/poky/
 
cd poky
 
git clone -b kirkstone git://git.openembedded.org/meta-openembedded
 
git clone -b kirkstone git://git.yoctoproject.org/meta-ti
 
git clone -b kirkstone https://git.yoctoproject.org/meta-arm
```
**meta-ti**: BSP của board
**meta-arm**: core arm

### 🔨 Setup và build
```bash
source oe-init-build-env build-bbb
```
- Set **$OEROOT** : Xác định thư mục gốc của yocto
- Set **$PATH** : Thêm bitbake vào path của session terminal, giống kiểu thêm vào biến môi trường ở Windows
- Set **$BUILDDIR** : Chọn thư mục output ./build-bbb (default sẽ là build, nhưng nếu chạy cho nhiều board thì nên chia riêng)
- Set **$BBPATH** : Để bitbake tìm thấy các layer
Tạo cấu trúc thư mục **$BUILDDIR**.

Sau khi chạy xong build ra file conf, trong đó có các file layer được gen ra như (**bblayers.conf**, **local.conf**,...).

### 📝 Thay đổi conf file
#### `local.conf`.
- `MACHINE`: Muốn build cho thiết bị nào như beangle bone các thứ.
- `DL_DIR`: Khi build nó sẽ tải thư mục cần thiết để vào trong thư mục đường dẫn để sẵn.
- `PACKAGE_CLASSES`: Muốn nén thành package gì như `rpm`, ...
- `EXTRA_IMAGE_FEATURES`: thêm feature của yocto thì feature này được liệt kê hết trên trang chính yocto. Xem ở link này [Feature](https://docs.yoctoproject.org/brief-yoctoprojectqs/index.html)
```bash
EXTRA_IMAGE_FEATURES ?= "debug-tweaks ssh-server-dropbear"
```
thêm 2 feature mỗi feature cách nhau dấu cách
- `IMAGE_INSTALL`: thêm package
thêm bình thường
```bash
IMAGE_INSTALL = "bc"
```
thêm vào cuối thì phải thêm vào dấu cách
```bash
IMAGE_INSTALL_append = " bc"
```

#### `bblayer.conf`
Định nghĩa việc dùng meta data nào layer nào chỉ cần liệt kê đường dẫn vào là được.

### 🚀 Build
```bash
bitbake core-image-minimal
```

### 🧪 Thử trên Ubuntu 
build bản quemux86-64 thì chạy bản vừa build
Đứng ở thư mục build
```bash
runqemu qemux86-64 nographic
```

## 📚 Thêm Meta Layer
[Create_Layer](https://docs.yoctoproject.org/dev/dev-manual/layers.htm)
```bash
bitbake-layers create-layer meta-scottrif
```
Sau khi chạy cũng có conf như mấy cái meta bình thường

`meta-scottrif` sẽ là tên layer muốn đặt.

