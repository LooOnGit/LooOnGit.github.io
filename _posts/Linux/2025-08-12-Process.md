---
title: "Process"
date: 2025-08-12 20:09:20 +0800
categories: [Linux]
tags: [Linux]
---

# üêß Process

## 1. üìÇ **Gi√≥i thi·ªáu**
- 1 Programming l√† m·ªôt t·∫≠p h·ª£p c√°c h∆∞·ªõng d·∫´n th·ª±c hi·ªán m·ªôt nhi·ªám v·ª• c·ª• th·ªÉ, c√≥ th·ªÉ ƒë∆∞·ª£c th·ª±c hi·ªán b·ªüi c√°c t·ªáp th·ª±c thi v√† ƒë∆∞·ª£c l∆∞u tr·ªØ tr√™n ·ªï c·ª©ng c·ªßa m√°y t√≠nh.

**VD**: 
nh∆∞ main.c

- 1 Process l√† 1 Programming ƒë∆∞·ª£c th·ª±c thi v√† s·ª≠ d·ª•ng t√†i nguy√™n c·ªßa h·ªá th√¥ng.

**VD:**
g·ªçi file main.c th·ª±c thi th√¨ g·ªçi l√† ti·∫øn tr√¨nh.

- C√°ch xem Process ch·∫°y nh∆∞ n√†o.

```shell
ps -aux
```
Trong 1 h·ªá ƒëi·ªÅu h√†nh th√¨ nhi·ªÅu Process th√¨ m·ªói Process s·∫Ω ƒë∆∞·ª£c ƒë·ªãnh danh b·∫±ng Process ID (PID).
![alt text](/assets/Linux/process/PID.png)

M·ªôt ch∆∞∆°ng tr√¨nh c√≥ th·ªÉ s·ª≠ d·ª•ng nhi·ªÅu Process, nh∆∞ng n√≥i c√°ch kh√°c nhi·ªÅu process c√≥ th·ªÉ ch·∫°y c√πng 1 ch∆∞∆°ng tr√¨nh.

### Search c√°c th√¥ng tin ti·∫øn tr√¨nh

`ps`   th√¥ng tin t·∫•t c·∫£ c√°c ti·∫øn tr√¨nh nh∆∞ng th√¥ng tin √≠t h∆°n.

`ps a` th√¥ng tin chi ti·∫øt t·∫•t c·∫£ c√°c ti·∫øn tr√¨nh.

`ps aux | prep exam` th√¥ng tin 1 ti·∫øn tr√¨nh c·ª• th·ªÉ  ·ªü ƒë√¢y t√¥i search ti·∫øn tr√¨nh exam.

## 2. üìù **Command-line Arguments**
1 main c√≥ 2 ƒë·ªëi s·ªë `argc` l√† s·ªë ƒë·ªëi s·ªë ƒë·∫ßu v√†o, `argv` l√† ƒë·ªëi s·ªë ƒë·∫ßu v√†o.
`program.c`
```c
int main( int argc, char * argv[] )
{
    int i;
    printf("\nYour program name is %s\n", argv[0]);
    printf("Your arguments are: \n");
    for(i = 1; i < argc; i++)
        printf("\t %s starts with %c\n", argv[i], argv[i][0]);
    return 0;
}
```
![alt text](/assets/Linux/process/agument.png)
**Result:**
```bash
./program.exe apple banana cat
```
```c
Your program name is ./program.exe
Your arguments are: 
     apple starts with a
     banana starts with b
     cat starts with c
```

## üóÉÔ∏è **Memory layout c·ªßa m·ªôt Process**
Memory layout cho 1 Process m·ªói Process ƒë∆∞·ª£c chia th√†nh nhi·ªÅu ph·∫ßn. Th·ª±c t·∫ø ch√∫ng g·ªçi l√† Segments (memory partitions)
- **Stack**: bi·∫øn local v√† function.
- **Heap**: C·∫•p ph√°t ƒë·ªông.
- **Uninitialized data**:bi·∫øn global v√† static ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o, gi√° tr·ªã trong n√†y kh·ªüi t·∫°o 0.
- **Initialized data**: bi·∫øn global v√† static ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o.
- **Text (ro)**: ch·ª©a code, m√£ m√°y, bi·∫øn const.

![alt text](/assets/Linux/process/vitual_memory_layout.png)

**check size memory**
![alt text](/assets/Linux/process/size1.png)

D√πng `valgrind` ƒë·ªÉ check leak memory
![alt text](/assets/Linux/process/memory_leak.png)

Check ra v·ªã tr√≠ c·ª• th·ªÉ
![alt text](/assets/Linux/process/check_leak.png)

![alt text](/assets/Linux/process/check_leak2.png)

## Virtual Memory
Vi·ªác ghi tr·ª±c ti·∫øp v√†o memory tr√™n MCU th√¨ ƒë∆∞·ª£c nh∆∞ng v·ªõi Linux th√¨ n√≥ kh√¥ng ghi tr·ª±c ti·∫øp m√† n√≥ c√≥ kƒ© thu·∫≠t ghi g·ªçi l√† `virtual memory`.
H·ªá ƒëi·ªÅu h√†nh s·∫Ω c·∫•p cho process m·ªôt kho·∫£ng t√†i nguy√™n
- `Process virtual address space` h·ªá ƒëi·ªÅu h√†nh chia th√†nh page nh·ªè.

- `Physical Memory`(RAM): c≈©ng ƒë∆∞·ª£c h·ªá ƒëi·ªÅu h√†nh chia th√†nh nhi·ªÅu page nh·ªè.

- `Page table`: d√πng ƒë·ªÉ mapping address tr√™n `virtual memory` v·ªõi `Physical Memory` l√†m cho bi·∫øt v·ªõi ƒë·ªãa ch·ªâ n√†o tr√™n virtual memory s·∫Ω l∆∞u v√†o address n√†o tr√™n physical.

![alt text](/assets/Linux/process/MMU.png)

**MMU (Memory Management Unit)**: d√πng ƒë·ªÉ chuy·ªÉn t·ª´ ƒë·ªãa ch·ªâ ·∫£o sang ƒë·ªãa ch·ªâ th·∫≠t.

![alt text](/assets/Linux/process/link_vitua.png)


# 4. Operation on Process
## System call fork()
T·∫°o ra 1 Process con t·ª´ Process hi·ªán t·∫°i (Parent Process).

![alt text](/assets/Linux/process/fork.png)

```c
#include <unistd.h>
#include <stdio.h>

int main() {
    int x = 1;
    printf("Before fork\n");

    pid_t pid;

    pid = fork(); // fork is called here

    // both processes execute from here
    if (pid < 0) {
        perror("fork failed");
        return 1;
    } else if (pid == 0) {
        // Child process
        x++;
        printf("\n");
        printf("This is the child process. My PID = %d. My parent's PID = %d\n", getpid(), getppid());
        printf("In child process x = %d\n", x);
    } else {
        // Parent process
        printf("\n");
        printf("This is the parent process. My PID = %d. My child PID = %d. My parent's PID = %d\n", getpid(), pid, getppid());
        printf("In parent process x = %d\n", x);
    }

    printf("Both processes continue here.\n");

    return 0;
}
```

**Result**
```c
Before fork

This is the parent process. My PID = 147931. My child PID = 147932. My parent's PID = 74569
In parent process x = 1
Both processes continue here.

This is the child process. My PID = 147932. My parent's PID = 147931
In child process x = 2
Both processes continue here.
```
## 1. `fork()` l√†m g√¨?
- `fork()` t·∫°o ra m·ªôt **ti·∫øn tr√¨nh con (child process)** t·ª´ ti·∫øn tr√¨nh cha (parent process).
- Sau khi g·ªçi `fork()`, c·∫£ cha v√† con **c√πng ch·∫°y ti·∫øp t·ª´ v·ªã tr√≠ ngay sau l·ªánh `fork()`**.
- K·∫øt qu·∫£ tr·∫£ v·ªÅ t·ª´ `fork()`:
  - Trong **cha**: tr·∫£ v·ªÅ **PID c·ªßa con** (m·ªôt s·ªë d∆∞∆°ng).
  - Trong **con**: tr·∫£ v·ªÅ **0**.
  - N·∫øu l·ªói: tr·∫£ v·ªÅ `-1`.

Process chilren c√≥ th·ªÉ `fork()` th√™m.

## Ch·∫°y ch∆∞∆°ng tr√¨nh kh√°c trong ti·∫øn tr√¨nh con

Sau khi fork(), ti·∫øn tr√¨nh con l√† b·∫£n sao c·ªßa cha.

N·∫øu mu·ªën con ch·∫°y h·∫≥n m·ªôt ch∆∞∆°ng tr√¨nh kh√°c, ta g·ªçi m·ªôt h√†m exec*.

Khi exec ch·∫°y th√†nh c√¥ng, m√£ ngu·ªìn hi·ªán t·∫°i trong con b·ªã thay th·∫ø, ch·ªâ c√≤n ch∆∞∆°ng tr√¨nh m·ªõi.

| H√†m        | ƒê·∫∑c ƒëi·ªÉm                                                                 |
| ---------- | ------------------------------------------------------------------------ |
| `execl()`  | Li·ªát k√™ tham s·ªë theo danh s√°ch (list).                                   |
| `execlp()` | Gi·ªëng `execl()`, nh∆∞ng t·ª± t√¨m ch∆∞∆°ng tr√¨nh trong bi·∫øn m√¥i tr∆∞·ªùng `PATH`. |
| `execv()`  | Truy·ªÅn tham s·ªë qua m·∫£ng (vector).                                        |
| `execvp()` | Gi·ªëng `execv()`, nh∆∞ng t√¨m trong `PATH`.                                 |
| `execve()` | H·ªá th·ªëng l√µi, cho ph√©p truy·ªÅn c·∫£ m√¥i tr∆∞·ªùng (environment).               |

## T·∫°i sao fork() khi g·ªçi fork() ch·ªâ ch·∫°y ƒëo·∫°n ch∆∞∆°ng tr√¨nh sau fork()?
### 1. Qu√° tr√¨nh chia s·∫Ω code v√† data (copy-on-write)
Khi fork() ƒë∆∞·ª£c g·ªçi ti·∫øn tr√¨nh cha v√† con kh√¥ng ƒë∆∞·ª£c sao ch√©p ngay l·∫≠p t·ª©c m√†, ban ƒë·∫ßu c·∫£ 2 ti·∫øn tr√¨nh cha v√† con ƒë·ªÅu d√πng chung 1 v√πng nh·ªõ cho ƒë·∫øn khi 1 trong 2 c√≥ s·ª± thay ƒë·ªïi th√¨ m·ªõi ƒë∆∞a ti·∫øn tr√¨nh con qua v√πng nh·ªõ ƒë∆∞·ª£c copy, ƒë√¢y l√† c√°ch ti·∫øt ki·ªám t√†i nguy√™n h·ªá th·ªëng.
### 2. Tr·∫°ng th√°i tr·∫£ v·ªÅ c·ªßa fork()
Sau khi g·ªçi fork(), c√≥ s·ª± ph√¢n bi·ªát r√µ r√†ng gi·ªØa ti·∫øn tr√¨nh cha v√† ti·∫øn tr√¨nh con, d·ª±a v√†o gi√° tr·ªã tr·∫£ v·ªÅ c·ªßa fork():
Ti·∫øn tr√¨nh cha nh·∫≠n gi√° tr·ªã tr·∫£ v·ªÅ l√† PID (process ID) c·ªßa ti·∫øn tr√¨nh con.
Ti·∫øn tr√¨nh con nh·∫≠n gi√° tr·ªã tr·∫£ v·ªÅ l√† 0
## T·∫°i sao nh·∫≠n gi√° tr·ªã 0 khi fork ·ªü ti·∫øn tr√¨nh con
Khi ti·∫øn tr√¨nh con nh·∫≠n gi√° tr·ªã 0, vi·ªác ph√¢n bi·ªát gi·ªØa ti·∫øn tr√¨nh cha v√† ti·∫øn tr√¨nh con tr·ªü n√™n r·∫•t r√µ r√†ng v√† d·ªÖ d√†ng trong m√£ ngu·ªìn.

# 6. Orphant and Zombie Process
## 1. Ti·∫øn tr√¨nh m·ªì c√¥i 
1 ti·∫øn tr√¨nh con m√† cha ch·∫øt g·ªçi l√† ti·∫øn tr√¨nh m·ªì c√¥i. Cha return tr∆∞·ªõc con g·ªçi l√† m·ªì c√¥i.

![alt text](/assets/Linux/process/orphant.png)

Khi ti·∫øn tr√¨nh cha ch·∫øt ƒëi th√¨ ti·∫øn tr√¨nh con ƒë∆∞·ª£c c·ª• t·ªï qu·∫£n l√Ω l√† ti·∫øn tr√¨nh **init** l√† th√†nh ph·∫ßn ƒë·∫ßu ti√™n ƒë∆∞·ª£c g·ªçi trong h·ªá ƒëi·ªÅu h√†nh

## 2. Ti·∫øn tr√¨nh zombie
Khi 1 Process k·∫øt th√∫c nh∆∞ng v·∫´n c√≤n th√¥ng tin trong process table cho h·ªá ƒëi·ªÅu h√†nh qu·∫£n l√Ω l√†m cho t√†i nguy√™n trong h·ªá ƒëi·ªÅu h√†nh ƒë·∫ßy.

![alt text](/assets/Linux/process/Z+.png)

**Z+**: L√† zombie

## 3. ƒê·ªÉ d·ªçn d·∫πp zombie

![alt text](/assets/Linux/process/wait.png)

d√πng wait ra ƒë·ªÉ khi con ch·∫øt th√¨ h·ªá ƒëi·ªÅu h√†nh b√°o. Tr√°nh t·∫°o r√°c cho h·ªá th·ªëng. 
V·ªõi ti·∫øn tr√¨nh zombie kh√¥ng d√πng **kill -9** ƒë∆∞·ª£c, th√¨ kill ch·∫øt cha ƒëi th√¨ th·∫±ng con s·∫Ω ƒë∆∞·ª£c c·ª• t·ªï qu·∫£n l√Ω, ƒë·ªÉ c·ª• t·ªï c√≥ h√†m wait qu·∫£n l√Ω gi·∫£i ph√≥ng h·∫øt m·∫•y con.