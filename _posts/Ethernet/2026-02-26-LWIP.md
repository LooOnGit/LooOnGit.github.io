---
title: "LWIP"
date: 2026-02-26 20:41:00 +0700
categories: [ETHERNET]
tags: [ETHERNET]
---

# LWIP

## LWIP là gì?
- Là một TCP/IP stack mã nguồn mở.
- Sử dụng ít RAM cho hệ thông embedded.

## Protocols của LwIP Stack
![protocols](/assets/Ethernet/protocols.png)
### Network Layer (Tầng IP)
- IPv4 và IPv6 (Internet Protocol v4 and v6).
- ICMP (Internet Control Message Protocol).
- IGMP (Internet Group Management Protocol).
- ARP (Address Resolution Protocol).
### Transport Layer
- TCP (Transmission Control Protocol).
- UDP (User Datagram Protocol).
### Application Layer (Built-in hoặc Add-on)
- HTTP (Hypertext Transfer Protocol).
- FTP (File Transfer Protocol).
- DNS (Domain Name System).
- SNMP (Simple Network Management Protocol).
- DHCP (Dynamic Host Configuration Protocol).
- MQTT (Message Queuing Telemetry Transport).
- PPP (Point to Point Protocol).

## Những loại API làm việc với LwIP
### RAW API
- Là API cấp thấp nhất.
- Sử dụng callback function để xử lý dữ liệu.
### NetIF API
- Là API cấp trung.
- Sử dụng struct để quản lý interface.
### Socket API
- Là API cấp cao nhất.
- Sử dụng struct để quản lý socket.

## Some Protocols files
![protocols](/assets/Ethernet/files-protocols.png)

## Ethernet Controller Interface
- Bản phát hành chính thức của LwIP không cung cấp sẵn phần port cho bất kỳ vi điều khiển nào.
- Nó đi kèm với một file tên là `ethernetif.c`, hoạt động như một giao diện trung gian giữa stack LwIP và bộ điều khiển Ethernet.
- File này được cung cấp dưới dạng khung (skeleton) để bạn hoàn thiện, nhằm hỗ trợ cho một kiến trúc phần cứng cụ thể.
- File `ethernetif.c` chứa các hàm đảm bảo việc truyền các frame dữ liệu giữa driver mức thấp (ví dụ: `stm32_eth.c`) và stack LwIP.

## Configuration
- LwIP có thể được điều chỉnh để phù hợp với yêu cầu của ứng dụng.
- Các tham số mặc định của stack có thể được tìm thấy trong file `opt.h`.
- File này nằm trong thư mục LwIP tại `src\include\LwIP\`.
- Để thay đổi các thiết lập này, một file mới được định nghĩa là `lwipopts.h`, dựa trên file `opt.h` và nằm trong thư mục LwIP tại `Target\`.

### Some LwIP configuration parameters
- `LWIP_DHCP`: Kích hoạt/Vô hiệu hóa DHCP.
- `MEMP_NUM_TCP_PCB` & `MEMP_NUM_UDP_PCB`: Số lượng kết nối TCP và UDP tối đa có thể hoạt động đồng thời.
- `MEM_SIZE`: Thiết lập kích thước vùng nhớ heap.
- `PBUF_POOL_SIZE` & `PBUF_POOL_BUFSIZE`: Thiết lập số lượng và kích thước của các buffer tương ứng.

## What is PBUF?
- PBUF là một kiểu dữ liệu `struct` dùng làm cơ sở để xây dựng các gói tin (packets).
- Nó hỗ trợ cấp phát bộ nhớ động cho nội dung gói tin và có thể tham chiếu đến nội dung được quản lý bên ngoài (trong cả RAM và ROM).
- Một gói tin có thể trải dài trên nhiều pbuf, được nối với nhau dưới dạng danh sách liên kết đơn (singly linked list). Điều này được gọi là "pbuf chain".
- Nhiều gói tin có thể được đưa vào hàng đợi (queued), cũng sử dụng danh sách liên kết đơn này. Điều này được gọi là "packet queue".

### PBUF Types
- **PBUF_RAM**:
    - pbuf được cấp phát động (`dynamically allocated`) trong bộ nhớ.
    - Toàn bộ pbuf nằm trong một khối bộ nhớ liên tục (`one contiguous chunk`).
- **PBUF_POOL**:
    - Việc cấp phát pbuf được thực hiện từ một pool các pbuf đã được cấp phát tĩnh trước đó với kích thước định sẵn.
    - Tùy thuộc vào kích thước dữ liệu cần cấp phát, một hoặc nhiều pbuf sẽ được cấp phát và nối thành chuỗi (chained).
- **PBUF_ROM**:
    - Không có việc cấp phát không gian bộ nhớ cho payload của người dùng.
    - Con trỏ payload của pbuf trỏ trực tiếp đến dữ liệu trong bộ nhớ ROM.
    - Chỉ có thể được sử dụng để gửi dữ liệu hằng số (constant data).
    - Thường dùng khi dữ liệu đã có sẵn trong bộ nhớ tĩnh (static memory).

### PBUF Structure
![buffer_manager](/assets/Ethernet/buffer_manager.png)
- **next**: Con trỏ đến pbuf tiếp theo trong một chuỗi pbuf (pbuf chain).
- **payload**: Con trỏ đến vùng dữ liệu thực tế của gói tin (payload).
- **len**: Độ dài của vùng dữ liệu trong pbuf hiện tại.
- **tot_len**: Tổng độ dài của pbuf hiện tại cộng với độ dài của tất cả các pbuf tiếp theo trong chuỗi.
- **ref**: (4 bit) Biến đếm tham chiếu (reference count), cho biết số lượng con trỏ đang tham chiếu đến pbuf này. Một pbuf chỉ có thể được giải phóng khỏi bộ nhớ khi biến đếm này bằng 0.
- **flags**: (4 bit) Cho biết loại của pbuf.

### API for managing pbufs
- **pbuf_alloc**: Cấp phát một pbuf mới.
- **pbuf_realloc**: Thay đổi kích thước (resize) một pbuf.
- **pbuf_ref**: Tăng biến đếm tham chiếu (reference count) của một pbuf.
- **pbuf_free**: Giảm biến đếm tham chiếu của pbuf. Nếu biến đếm bằng 0, pbuf sẽ được giải phóng.
- **pbuf_clen**: Trả về số lượng pbuf trong một chuỗi pbuf (pbuf chain).
- **pbuf_cat**: Nối hai chuỗi pbuf lại với nhau (nhưng không thay đổi biến đếm tham chiếu của chuỗi pbuf phía sau).
- **pbuf_chain**: Nối hai chuỗi pbuf lại với nhau (biến đếm tham chiếu của chuỗi pbuf phía sau sẽ được tăng lên).
- **pbuf_dechain**: Tách pbuf đầu tiên ra khỏi các pbuf tiếp theo trong chuỗi.
- **pbuf_copy_partial**: Sao chép (một phần) nội dung của một packet buffer vào một buffer do ứng dụng cung cấp.
- **pbuf_take**: Sao chép dữ liệu do ứng dụng cung cấp vào một pbuf.
- **pbuf_coalesce**: Tạo ra một pbuf duy nhất từ một hàng chờ (queue) các pbuf.



