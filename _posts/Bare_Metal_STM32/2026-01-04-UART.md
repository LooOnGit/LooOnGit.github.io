---
title: "The Universal Asynchronous Receiver/Transmitter Protocol"
date: 2026-01-04 19:23:26 +0700
categories: [Bare Metal STM32]
tags: [Bare Metal STM32]
---

# The Universal Asynchronous Receiver/Transmitter Protocol

## Introduction to communucation protocols
Trong embedded system, communication protocols thì cần thiết để cho phép MCU và các thiết bị ngoại vi khác có thể giao tiếp với nhau.
### What is a communication protocol?
Communication protocol thì được set rule và thuận tiện cho phép các device để giao tiếp với nhau. Những protocol được xác định formate như thế nào, trasmit, và receive, đảm bảo rằng thiết bị có thể trao đổi thông tin chính xác và tin cậy.Nếu không có các giao thức này, việc giao tiếp sẽ giống như cố gắng trò chuyện với một người nói một ngôn ngữ hoàn toàn khác – sự truyền thông sẽ trở nên hỗn loạn và dễ xảy ra lỗi.

#### Serial versus parallel communication
**Serial communication**


- **Asynchronous**: Loại giao tiếp mà gửi một data 1 bit ở 1 thời điểm không có 1 signal để synchronize giữa sender và receiver. Nghĩ như là gửi lá thư thông qua mail không có kế hoạch thời gian. Một ví dụ chung là UART, nó có bản và hiểu qua cho nhiều application.
- **Synchronous**: Giao tiếp sử dụng clock signal để điều phối gửi những bit. Có thể hình dung như có một nhịp trống đề đảm bảo mọi thư diễn ra đồng bộ cùng nhịp.l Ví dụ bao gồm **Serial Peripheral Interface (SPI)** và **Inter-Integrated Circuit (I2C)**. Có nhiều protocol đảm bảo tính toàn vẹn và thời gian, khiến chúng phù hợp cho nhiều task phức tạp.


**Parallel communication**
Kiểu này liên quan đến việc truyền nhiều bit cùng lúc nhiều kênh song song. Có thể hình dung như việc gửi cả một đoàn xe thay vì chỉ một chiếc - nhanh hơn nhưng đòi hỏi nhiều làn đường hơn (hay trong trường hợp của chúng ta làm nhiều chân/pin hơn).

Mặc dù **parallel communication** có tốc độ cao hơn, nhưng ít phổ biến trong embedded system bởi vì nhiều chân hơn. Ngoài ra, kiểu truyền này dễ bị nhiễu xuyên âm (Crosstalk) và toàn vẹn signal, đặc biệt khi truyền ở khoảng cách xa.

#### Point-to-point versus multi-point communication
**Point-to-point**
Đây là một đường truyền thông trực tiếp giữa hai thiết bị. UART là một ví dụ điển hình, trong đó dữ liệu được truyền trực tiếp giữa vi điều khiển và một thiết bị ngoại vi. Cách truyền này đơn giản, đáng tin cậy, và rất phù hợp cho nhiều hệ thống nhúng.


**Multi-device (bus) communication**
- **Multi-master**: Đa thiết bị thì có thể điều khiển truyền thông bus **I2C** thì tốt, ví dụ như nó cho phép nhiều master và nhiều slave trên cùng một bus. Nó giống một đám bạn đang nói chuyện với nhau.
- **Master-slave**: Một master device điều khiển truyền thông. Định hướng luồng dữ liệu đến và đi từ nhiều device. **SPI** hoạt động cách này giao tiếp giữa 1 master và nhiều slave.**I2C** cũng có thể hoạt động theo cách này.

#### Full-duplex versus half-duple
- **Full-duplex**: Cho phép đồng thời 2 chiều. Tưởng tượng một con đường có 2 làn, nơi các xe hơi có thể di chuyển cùng lúc theo cả 2 hướng. UART và SPI hỗ trợ chế độ full-duplex, giúp chúng rất hiệu quả cho việc trao đổi dữ liệu thời gian thực.
- **Half-duplex**: Ở chế độ này, việc truyền thông có thể diễn ra theo cả hai hướng, nhưng không đồng thời - giống như mộ con đường một làn, nơi các xe phải lần lượt đi qua. I2C thường hoạt động ở chế độ bán song công (half-duplex), cách này phù hợp với mục đích sử dụng của nó nhung có thể trở thành hạn chế trong các kích bản truyền dữ liệu tốc độ cao.

### Comparing UART, SPI, I2C
#### UART
- **Asynchronous communication**: UART không yêu cầu clock signal. Thay vào đó, nó sử dụng start bit và stop bit để đồng bộ hóa dữ liệu.
- **Full-duplex**: UART có thể gửi và nhận data đồng thời, ý tưởng này cho nhiều application yêu cầu giao tiếp real-time.
- **Simple and cost-effective**: Với yêu cầu hardware đơn gian, UART thì dễ thực thi với giá hiệu quả.

**Nhược điểm**
- **Speed limitations**: UART tốc độ chậm hơn so với SPI và I2C, do đó không phù hợp cho các ứng dụng yêu cầu tốc độ cao.
- **Limited distance**: Khả năng nhạy cảm với nhiễu, UART có thể bị ảnh hưởng bởi nhiễu điện tử, đặc biệt khi truyền ở khoảng cách xa.
- **Point-to-point only**: UART thiết kế cho trực tiếp , point-to-point communication, nó có thể giới hạn nhiều thiết bị cần giao tiếp.
#### SPI
- **Synchronous communication**: SPI sử dụng tín hiệu xung nhịp cùng với các đường dữ liệu, đảm bảo việc truyền dữ liệu được đồng bộ.
- **Full-duplex**: Cho phép gửi và nhận dữ liệu đồng thời.
- **Master-slave architecture**: Một thiết bị master điều khiển nhiều thiết bị slave, với các đường chọn (select line) riêng cho từng slave.


**Ưu điểm**
- **High speed**:SPI hỗ trợ truyền dữ liệu tốc độ cao, rất phù hợp cho các ứng dụng yêu cầu giao tiếp nhanh.
- **Versatility**: SPI có thể kết nối nhiều thiết bị với các cấu hình khác nhau, mang lại sự linh hoạt trong thiết kế.


**Nhược điểm**
- **More pins required**:Mỗi thiết bị slave cần một đường chọn riêng, điều này có thể làm tăng đáng kể số lượng chân sử dụng.
- **No standardized acknowledgment**: Không giống như I2C, SPI không có cơ chế xác nhận (acknowledgment) tích hợp sẵn, khiến việc phát hiện lỗi trở nên khó khăn hơn.
- **Limited multi-master capability**: SPI không được thiết kế cho các hệ thống có nhiều master, điều này có thể là một hạn chế trong một số trường hợp.

#### I2C
- **Synchronous communication**: I2C sử dụng clock signal cho synchronized data transfer.
- **Full-duplex**: Cho phép gửi và nhận dữ liệu đồng thời.
- **Multi-master capability**: Multiple master devices có thể dùng chung bú, rất hữu ích trong các hệ thống phức tạp hơn. 
- **Two-wire interface**: I2C chỉ cần hai đường (SDA và SCL) để giao tiếp, giúp giảm thiểu số lượng chân kết nối.


**Ưu điểm**
- **Simplicity in writing**: Giao diện hai dây làm giảm độ phức tạp và số lượng chân cần sử dụng.
- **Multi-device support**: Giao diện hai dây làm giảm độ phức tạp và số lượng chân cần sử dụng.


**Nhược điểm**
- **Slower speed**: I2C nhìn chung chậm hơn SPI, điều này có thể là hạn chế đối với các ứng dụng yêu cầu tốc độ cao.
- **Complex protocol**:I2C nhìn chung chậm hơn SPI, điều này có thể là hạn chế đối với các ứng dụng yêu cầu tốc độ cao.
- **Susceptible to noise**: So với UART và SPI, giao thức I2C phức tạp hơn, đòi hỏi việc xử lý truyền dữ liệu và địa chỉ phải tinh vi hơn.

### Common use cases for the UART, SPI, I2C protocols
#### UART
- **Serial communication with PCs**: UART thì thường sử dụng cho giao tiếp giữa máy tính và MCU, cụ thể cho debugging, firmware updates và data logging.
- **GPS module**: UART có thể sử dụng để gửi vị trí từ 1 module GPS đến MCU.
- **Bluetooth module**: UART có thể giao tiếp không dây thông qua Bluetooth.
#### SPI
- **High-speed data transfer**: Ứng dụng chẳng hạn như memory cards, analog-to-digital converters (ADCs), digital-to-analog converters (DACs), và display.
- **Display module**: SPI có thể sử dụng cho giao tiếp với display module, với yêu cầu tốc độ nhanh.
- **Sensors and actuators**: SPI có thể sử dụng cho data tần số cao output từ nhiều loại sensor.
#### I2C
- **Multiple sensor integration systems**: Trường hợp này liên quan đến việc kết nối nhiều cảm biến có các địa chỉ khác nhau trên cùng một bus I2C.
- **Peripheral expansion**: Trường hợp này liên quan đến việc bổ sung thêm các chân GPIO cho vi điều khiển bằng cách sử dụng các IC mở rộng I2C (I2C expanders).

## Overview of the UART protocol
### What is UART?
UART là giao tiếp bất đồng bộ có thể điều chỉnh tốc độ, thay vì 2 thiết bị đồng ý. Thay vào đó, cả hai thiết bị phải thống nhất với nhau một giá trị baud rate cụ thể, giá trị này quyết định tốc độ trao đổi dữ liệu.
### The interface
![UART connected](/assets/Bare_Metal_STM32/UART/image.png)

2 dây của UART là TX (Transmit) và RX (Receive), phải có GND để biết mức điện logic có GND để nó dự vào đó để biết giá trị điện áp theo chuẩn TTL.

### How UART works
![data pack](/assets/Bare_Metal_STM32/UART/image1.png)


Data của UART được gửi thì frame sẽ chưa **start bit**, **data bits**, **stop bit**.
#### Start bit
Dùng để báo cho biết bắt đầu data frame trong truyền thông UART. Khi gửi thiết bị ở trạng thái idle, data line được đưa lên mức cao (logic 1). Để bắt đầu gửi, UART sẽ kéo xuống mức thấp (logic 0) cho 1 bit. Trạng thái chuyển từ high sang low thông báo thiết bị nhận rằng có data mới đến.
#### Stop bit
Sau khi data và optional parity bit được gửi, bit stop để kết thúc data frame. Điều khiển gửi data để điện áp cao (logic 1) cho 1 hoặc 2 bit, phụ thuộc vào cấu hình. Stop bit(s) đảm bảo rằng gửi có thời gian xử lý data bit mới nhất và chuẩn bị cho start bit tiếp theo.
#### Parity bit
Để check error trong UART. Nó cung cấp một phương thức cơ bản để nhận diện **error** có thể xảy ra trong suốt quá trình data gửi. 
- **Even parity**: Parity bit được set 0 nếu data frame là even, và set 1 nếu là odd.
- **Odd parity**: Parity bit được set 1 nếu data frame là even, và set 0 nếu là odd.


Khi thiết bị nhận nhận được khung dữ liệu, nó sẽ kiểm tra bit chẵn lẻ (parity bit) so với các bit dữ liệu đã nhận. Nếu có sự không khớp, điều đó cho thấy đã xảy ra lỗi trong quá trình truyền. Mặc dù parity không thể tự sửa lỗi, nhưng nó giúp phát hiện lỗi, từ đó có thể yêu cầu truyền lại dữ liệu nếu cần thiết.


#### Understanding the baud rate - the speed of communication in embedded systems
**What is the baud rate?**


Baud rate về cơ bản là tốc độ mà dữ liệu được truyền qua một kênh truyền thông. Nó được đo bằng **bit trên giây (bps)**. Có thể hình dùng giống tốc độ giới hạn khi một xe chạy trên đường cao tốc: baud rate càng cao có thể đi qua đường truyền trong cùng 1 khoảng thời gian.


Ví dụ, một baurate 9600 có nghĩa là 9600 bit dữ liệu được truyền mỗi giây. Nói cách khác, nó set pace mà các gói dữ liệu được gửi và nhận.


Tuy nhiên, phân biệt giữa **baud rate** và **bit rate**. Trong khi **baud rate** chỉ tín hiệu thay đổi mỗi giây, **bit rate** là số bit gửi mỗi giây. 


Trong các hệ thống đơn giản, mỗi lần thay đổi tín hiệu biểu diễn một bit, nên baud rate và bit rate là như nhau. Trong các hệ thống phức tạp hơn, mỗi lần thay đổi tín hiệu có thể biểu diễn nhiều bit, do đó bit rate sẽ lớn hơn baud rate.


**Why does the baud rate matter?**
Hình dung 1 người nói nhanh hơn bạn. Thì sẽ dễ bị trôi thông tin và gây nhầm lẫn không hiệu quả, tương tự các thiết bị khác nhau cũng vậy. Khi cả 2 gửi và nhận thiết bị cần đồng ý một baud rate để hiểu nhau.


### The STM32F4 UART peripheral
#### USART so với UART
Trong tài liệu STM32, ngoại vi UART được gọi là **USART Universal Synchronous/Asynchronous Receiver/Transmitter**
- **Asynchronous mode (UART)**: Trong mode này, USART hoạt động như UART truyền thống. Nó transmit và receive data không cần clock signal, đây là tiêu chuẩn giao tiếp phổ biến nhất.
- **Synchronous mode (USART)**: Trong mode này, USART hoạt động như UART truyền thống, cho phép giao tiếp các thiết bị yêu cầu thêm đường clock bên cạnh đường dữ liệu.

#### USART Status Register (USART_SR)
Register này là một register chính sử dụng giám sát trạng thái UART peripheral. Nó cung cấp thông tin real-time về nhiều flags và errors.


Những bit chính của register:
- **Transmit data register empty (TXE)**: Bit này được set khi register là empty và ready cho data mới để được ghi vào. Nó cho biết có thể gửi thêm dữ liệu.
- **Read data register not empty (RXNE)**: Bit này chỉ định rằng data register chứa data chưa được đọc. Nó báo hiệu rằng có dữ liệu đến cần được xử lý.
- **Transmission complete (TC)**: Bit này được set khi quà truyền cuối cùng đã hoàn tất, bao gồm cả các bit stop. Nó cho biết dữ liệu đã được gửi xong hoàn toàn.
- **Overrun error (ORE)**: Bit này được set khi dữ liệu không được đọc kịp trước khi dữ liệu mới đến. Nó dùng để báo lỗi tràn dữ liệu.

#### USART Baud Rate Register (USART_BRR)
Thanh ghi USART_BRR được sử dụng để thiết lập baud rate cho giao tiếp UART, yếu tố rất quan trọng để đồng bộ tốc độ truyền dữ liệu giữa các thiết bị.


Register này có 2 fields:
- **Mantissa**: Phần nguyên của hệ số chia dùng để thiết lập baud rate.
- **Fraction**: Phần thập phân của hệ số chia, dùng để tinh chỉnh chính xác baud rate.
#### USART Control Register 1 (USART_CR1)
**USART_CR1** register là một thanh ghi điều khiển toàn diện, cho phép cấu hình và kích hoạt nhiều chức năng khác nhau của UART.
- **USART enable (UE)**: Bit này enable hoặc disable UART peripheral. Nó phải set để kích hoạt giao tiếp UART.
- **Word length (M)**: Bit này được cấu hình độ dài word, cho phép 8-bit hoặc 9-bit data frames.
- **Parity control enable (PCE)**: Bit này enable parity kiểm tra nhận diện error.
- **Parity selection (PS)**: Bit này chọn even hoặc odd parity.
- **Transmitter enable (TE)**: Bit này enable để transmitter, cho phép data được gửi.
- **Receiver enable (RE)**: Bit này enable để receiver, cho phép data được received.

## Developing the UART driver
Links:  [Code Uart](https://github.com/LooOnGit/Bare_Metal_STM/commit/a4eead083931c077245831a74325cfa146faf2b3)
