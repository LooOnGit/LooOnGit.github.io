---
title: "CMSIS"
date: 2025-12-28 11:07:28 +0700
categories: [Bare Metal STM32]
tags: [Bare Metal STM32]
---

# The Common Microcontroller Software Interface Standard (CMSIS)
**CMSIS** là framework quan trọng cho Cotex-M và mỗi Cotex-A. Nó cho biết define hardware register sử dụng C structure.
## Defining peripheral registers with C structures
Trong embedded system development, define hardware register sử dụng C structure trên nền tảng để cài thiện cách đọc code và maintain cho dễ.
### Getting the base address and offset of registers
Trong datasheet phần memory map, có thể thấy base address.


![Base address](/assets/Bare_Metal_STM32/CMSIS/image.png)


Trong mỗi base address của GPIO register sẽ có nhiều register khác nhau.


![GPIO](/assets/Bare_Metal_STM32/CMSIS/image1.png)


Nó sẽ giống như một căn hộ sẽ có nhiều phòng, mỗi phòng này sẽ giống như là register. Mỗi phòng sẽ có mục đích để nhà kho, phòng ăn hay gì đó các thứ và mỗi phòng đều có kích thước riêng thì nó sẽ tương tự offset. 
### Implementing the peripheral structures
```c
typedef struct
{
   volatile uint32_t MODER; /*offset: 0x00 */
   volatile uint32_t OTYPER; /*offset: 0x04 */
   volatile uint32_t OSPEEDR; /*offset: 0x08 */
   volatile uint32_t PUPDR; /*offset: 0x0C */
   volatile uint32_t IDR; /*offset: 0x10 */
   volatile uint32_t ODR; /*offset: 0x14 */
   volatile uint32_t BSRR; /*offset: 0x18 */
   volatile uint32_t LCKR; /*offset: 0x1C */
   volatile uint32_t AFRL; /*offset: 0x20 */
   volatile uint32_t AFRH; /*offset: 0x24 */
} GPIO_TypeDef;
```
Mỗi member của structure thì sẽ khai báo `volatile uint32_t`:
- `volatile`: Chỉ định rằng var này có thể thay đổi bất cứ lúc nào, thường bởi hardware. Để nói cho compiler không optimize đến var này.
- `uint32_t`: Chỉ định mỗi member của structure này có kích thước là 32-bit (4byte) unsigned integer. 

Mỗi peripheral hoạt động đều phải enable RCC cần cho hoạt động.
```c
typedef struct
{
   volatile uint32_t DUMMY[12];
   volatile uint32_t AHB1ENR; /*offset: 0x30*/
} RCC_TypeDef
```
RCC này nhằm mục đích enable clock cho GPIO register là AHB1ENR, có offset là 0x30. Trong trường hợp này, số lượng là 12 item. Điều này là bởi vì 4 byte nhân với 12 bằng 48 byte, tương ứng với 0x30 theo HEX.

```c
#define RCC_BASE 0x40023800
#define GPIOA_BASE 0x40020000
#define RCC ((RCC_TypeDef*) RCC_BASE)
#define GPIOA ((GPIO_TypeDef*)GPIOA_BASE)
```
### Evaluating the structure-based register access method
```c
// 0: Include standard integer types header for fixed-width //integer
types
#include <stdint.h>

// 1: GPIO_TypeDef structure definition
typedef struct
{
   volatile uint32_t MODER; /*offset: 0x00 */
   volatile uint32_t OTYPER; /*offset: 0x04 */
   volatile uint32_t OSPEEDR; /*offset: 0x08 */
   volatile uint32_t PUPDR; /*offset: 0x0C */
   volatile uint32_t IDR; /*offset: 0x10 */
   volatile uint32_t ODR; /*offset: 0x14 */
   volatile uint32_t BSRR; /*offset: 0x18 */
   volatile uint32_t LCKR; /*offset: 0x1C */
   volatile uint32_t AFRL; /*offset: 0x20 */
   volatile uint32_t AFRH; /*offset: 0x24 */
} GPIO_TypeDef;

// 2: RCC_TypeDef structure definition
typedef struct
{
   volatile uint32_t DUMMY[12];
   volatile uint32_t AHB1ENR; /*offset: 0x30*/
} RCC_TypeDef;

// 3: Base address definitions
#define RCC_BASE 0x40023800
#define GPIOA_BASE 0x40020000

// 4: Peripheral pointer definitions
#define RCC ((RCC_TypeDef*) RCC_BASE)
#define GPIOA ((GPIO_TypeDef*)GPIOA_BASE)

//5: Bit mask for enabling GPIOA (bit 0)
#define GPIOAEN (1U<<0)

//6: Bit mask for GPIOA pin 5
#define PIN5 (1U<<5)

//7: Alias for PIN5 representing LED pin
#define LED_PIN PIN5

// 8: Start of main function
int main(void)
{
   // 9: Enable clock access to GPIOA
   RCC->AHB1ENR |= GPIOAEN;

   GPIOA->MODER |= (1U<<10); // 10: Set bit 10 to 1
   GPIOA->MODER &= ~(1U<<11); // 11: Set bit 11 to 0

   // 21: Start of infinite loop
   while(1)
   {
      // 12: Set PA5(LED_PIN) high
      GPIOA->ODR^= LED_PIN;

      // 13: Simple delay
      for(int i=0;i<100000;i++){}
   }
}
```

## Understanding CMSIS
### What is CMSIS?
CMSIS, đọc là See-M-Sys, là một chuẩn do Arm phát triển để cung cấp cách tiếp cận nhất quán và hiệu quả trong việc lập trình các vi điều khiển dựa trên Cortex. Mục tiêu chính là đơn giản hóa và chuẩn hóa quá trình phát triển phần mềm nhúng.


Lợi ích bao gồm như sau:
- **Standardization** (Chuẩn hóa): CMSIS standardize interface cho tất cả Cotex-bases MCU, Giúp các kỹ sư đổi giữa MCU khác nhau dễ dàng mà không phải viết lại toàn bộ code.
- **Portability** (Tính di động): Cung cấp API nhất quán, CMSIS cho phép software develop MCU dễ dàng chuyển đổi giữa MCU khác nhau mà không phải viết lại toàn bộ code.
- **Efficiency** (Hiệu quả): CMSIS bao gồm tối ưu library và functions, chẳng hạn như Digital Signal Processing (DSP) và Neural Network kernels, nó cải thiện và giảm dung lượng code. 
### Key components of CMSIS
- **CMSIS Core-(M)**: Thiết kế cho tất cả Cortex-M and SercurCore processors. Nó cung cấp API cho cấu hình Cortex-M processor core và peripheral. Nó chuẩn hóa tên device peripherals register, Nó giảm thời gian học khi chuyển sang MCU mới.
- **CMSIS-Driver**: Nó cung cấp tạo ra prepheral driver cho middleware.
- **CMSIS-DSP**: Thư viện xử lý tín hiệu số tối ưu.
- **CMSIS-NN**: Thư viện mạng nơ-ron tối ưu.
- **CMSIS-RTOS**: API chung cho RTOS, hỗ trợ nhiều MCU.
- **CMSIS-Pack**: Hệ thống phân phối phần mềm và quản lý lifecycle.
- **CMSIS-SVD**: File mô tả ngoại vi MCU, hỗ trợ debug tự động.
### The CMSIS coding rules
Ở đây là cần thiết coding rules và điều kiện sử dụng CMSIS.
- Compliance with MISRA C (C99) and C++ (C++03): Điều này đảm bảo rằng chương trình được chuẩn hóa và có thể mở rộng.
- Standard data types: Sử dụng tiêu chuẩn ANSI C define data trong `<stdint.h>`, đảm bảo nhất uán trong đại diện data.
- Complete data types: Biến và đối số thì define với loại data hoàn chỉnh, tránh sự mơ hồ.
- MISRA 2012 conformance: CMSIS tuân thủ với MISRA 2012, nó không khẳng định tuân thủ đầy đủ MISRA.
### The CMSIS-Core files
![CMSIS-Core](/assets/Bare_Metal_STM32/CMSIS/image2.png)


Những file này thì chia ra 3 danh mục: **CMSIS-Core Standard Files**, **CMSIS_Core Device Files**, và **User Programe Files**.


**CMSIS-Core Standard Files**: Được cung cấp nhiều file từ Arm và thương không cần chỉnh sửa. 
- `core_<cpu>.h`: Được cung cấp để truy cập CPU và tính năng core-specific.
- `cmsis_compiler.h`: Chứa function của peripheral, truy cập các lệnh của CPU và các lệnh của SIMD (Single Instruction Multiple Data).
- `<arch>_<feature>.h`: Define các thuộc tính và tính năng cảu kiến trúc.
- `cmsis_<compiler>_m.h`: Chỉ định toolchain tương thích compiler và optimization.

**CMSIS_Core Device Files**: Được cung cấp file từ silicon (chẳng hạn như STMicroelectronics) và có thể yêu cầu chỉnh sửa.
- `system_<Device>.c`: File này hanles system and clock configuration.
- `partition_<Device>.h`: Quản lý thuộc tính secure và interrupt. 
- `startup_<Device>.c`: Chứa Startup interrupt vector table.
- `<Device>.h`: Cung cấp quyền truy cấp vào các chức năng GPIO của peripheral theo chuẩn CMSIS.
- `symtem_<Device>.c`: Hổ trợ trong system và clock configuration.


**User Program Files**: Được tạo ra bởi Dev và bao gồm main application. 
## Setting up the required CMSIS files
### Getting the right header files
Vào link này là STM32CubeF4 để tải pack của nó


[STM32CubeF4](https://www.st.com/en/embedded-software/stm32cubef4.html#overview)


Giải nén ra và bạn sẽ tìm đến thư mục `Drivers`. 


### Working with the CMSIS files
