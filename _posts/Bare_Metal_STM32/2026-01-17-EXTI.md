---
title: "EXTI"
date: 2026-01-17 21:15:43 +0700
categories: [Bare Metal STM32]
tags: [Bare Metal STM32]
---

# EXTI

## Interrupts and their role in firmware
Ngắt là một trong những cơ chế quan trọng nhất trong các hệ thống nhúng, cho phép vi điều khiển phản ứng với các sự kiện thời gian thực một cách hiệu quả. Để hiểu đầy đủ vai trò của ngắt trong firmware, điều cần thiết là phải nắm được ngắt là gì, cách chúng hoạt động ra sao và những tình huống khác nhau mà chúng tỏ ra không thể thiếu. Vì vậy, hãy cùng tìm hiểu và khám phá thế giới thú vị của ngắt, cách vận hành của chúng và các ứng dụng thực tế.
### What is an interrupt?
Hãy tưởng tượng bạn đang chăm chú đọc một cuốn sách thì chuông cửa reo. Bạn tạm thời dừng việc đọc, ra mở cửa tiếp khách, rồi sau đó quay lại đọc tiếp cuốn sách. Ngắt trong vi điều khiển hoạt động theo cách tương tự. Chúng là các tín hiệu làm tạm dừng việc thực thi chương trình hiện tại để cho phép một chương trình con đặc biệt, gọi là ISR (Interrupt Service Routine – trình phục vụ ngắt), được chạy. Khi ISR hoàn thành, vi điều khiển sẽ tiếp tục thực thi chương trình trước đó đúng tại vị trí mà nó đã tạm dừng.


Ngắt có thể được kích hoạt bởi các sự kiện phần cứng, chẳng hạn như bộ định thời bị tràn, một nút nhấn được bấm, hoặc dữ liệu được nhận trên giao diện truyền thông. Chúng cũng có thể được tạo ra bởi phần mềm, mang lại sự linh hoạt trong việc quản lý cả các sự kiện bên ngoài lẫn bên trong hệ thống.
### How do interrupts work?
- **Interrupt request**: Một event trigger **Interrupt Request (IRQ)**.
- **Acknowledge and priority**: Bộ điều khiển ngắt sẽ xác nhận yêu cầu và xác định mức độ ưu tiên của ngắt dựa trên các mức đã được định nghĩa trước.
- **Context save**: CPU lưu lại trạng thái thực thi hiện tại của nó (ví dụ: thanh ghi, bộ đếm chương trình, cờ trạng thái…).
- **Vector fetch**: CPU lấy địa chỉ của ISR từ bảng vector ngắt (IVT – Interrupt Vector Table).
- **ISR execution**: ISR được chạy để xử lý sự kiện gây ra ngắt.
- **Context restore**: Sau khi ISR hoàn thành, CPU khôi phục lại trạng thái thực thi trước đó.
- **Resume execution**: CPU tiếp tục chạy tác vụ đã bị gián đoạn trước khi ngắt xảy ra.
### Importance of interrupts in firmware
- **Real-tiome respone**: Interrupt cho phép 1 MCU gần như ngay lập tức phản ứng hầu hết các sự kiện quan trọng. Ví dụ, trong một hệ thông điều khiển động cơ, 1 interruptcos thể ngay lập tức xử lý một sensor signal chỉ định rằng motor có dựa vào vị trí mong muốn của nó.
- **Resource optimization**: Thay vì liên tục polling cho events (Nó lãng phí chu kỳ xung CPU và power), interrupt cho phép CPU ở trạng thái tiêu thụ năng lượng thấp hoặc tập trung xử lý các tác vụ khác cho đến khi một sự kiện ngắt xảy ra. Điều tối ưu này chủ yếu thiết bị chay bằng pin như thiết bị đeo (wearables) hoặc các cảm biến từ xa.
- **Prioritization and preemption**: Interrupt có thể ưu tiên, cho phép nhiều task hơn có thể ngắt các tác vụ ít quan trọng hơn. Điều này đảm bảo rằng task ưu tiên cao, chẳng hạn như dừng khẩn cấp trong máy móc công nghiệp, sẽ được xử lý ngay lập tức.
### Interrupts versus exceptions
Ngắt (**interrupts**) là các tín hiệu từ phần cứng hoặc phần mềm, cho biết mộ sự kiện cần được xử lý ngay lập tức. Ví dụ, bộ định thời bị tràn (timer overflow), trạng thái chân GPIO thay đổi, và dữ liệu được nhận từ các ngoại vi.


Interrupt cho phép embedded system để xử lý real-time events và thiết yếu cho hoạt động nhanh và hiệu quả. Khi một interrupt xảy ra, CPU dừng thực thi main program và chuyển đến địa chỉ tiền khai báo thực thi ISR.
### The NVIC, ISR, and IVT
#### The NVIC
- NVIC (Nested Vectored Interrupt Controller) là một hardware module được tích hợp trong Arm Cortex-M để quản lý mức độ ưu tiên và xử lý ngắt. Nó cho phép micontroller để phản hồi ngắt nhanh và hiệu quả. 
- **Interrupt prioritization**: NVIC hỗ trợ nhiều mức độ ưu tiên khác nhau, cho phép chúng ta gán mức ưu tiên khác nhau cho từng ngắt. Điều này đảm bảo rằng các tác vụ quan trọng hơn sẽ được xử lý trước.
- **Nested interrupts**: NVIC cho phép các ngắt có mức ưu tiên cao hơn có thể ngắt các ngắt có mức ưu tiên thấp hơn. Tính năng này rất quan trọng để duy trì khả năng phản hồi của hệ thống trong các ứng dụng thời gian thực.
- **Dynamic priority adjustment**: Chúng ta có thể thay đổi mức độ ưu tiên của các ngắt trong thời gian chạy (runtime), mang lại sự linh hoạt để thích ứng với các điều kiện hoạt động thay đổi.

![frame](/assets/Bare_Metal_STM32/EXTI/image.png)

#### ISR
ISR là một thành phần then chốt trong việc xử lý ngắt của các hệ thống nhúng. ISR là một hàm đặc biệt mà CPU sẽ thực thi để phản hồi lại một ngắt. Mỗi ngắt đều có ISR riêng của nó.


Khi một ngắt xảy ra, CPU sẽ tạm thời dừng tác vụ hiện tại, lưu lại trạng thái (context), và nhảy đến địa chỉ (hàm) ISR đã được xác định trước để thực thi đoạn mã cần thiết.
#### IVT (Interrupt Vector Table)
IVT giống như một “bản đồ chỉ đường” cho CPU khi xảy ra ngắt. Đây là một cấu trúc dữ liệu chứa địa chỉ của tất cả các ISR. Mỗi nguồn ngắt được gán cho một mục (entry) cụ thể trong bảng này, ánh xạ nó đến ISR tương ứng.


Khi một ngắt được kích hoạt, CPU sẽ tra cứu IVT để tìm địa chỉ của ISR tương ứng với ngắt đó. Quá trình tra cứu này đảm bảo CPU có thể nhảy nhanh và chính xác đến đoạn mã cần thiết để xử lý sự kiện.
- **Fixed location**: IVT thường được đặt tại một địa chỉ cố định trong bộ nhớ. Đối với các vi điều khiển ARM Cortex-M, IVT bắt đầu tại địa chỉ 0x00000000.
- **ISR addresses**: Mỗi entry trong IVT chứa địa chỉ của một ISR. Khi xảy ra ngắt, CPU sử dụng IVT để nhanh chóng xác định và nhảy đến ISR phù hợp.
- **Vector numbers**: Mỗi nguồn ngắt được gán một số vector duy nhất, tương ứng với một entry trong IVT.
Ví dụ: vector số 0 có thể dành cho ngắt reset, vector số 1 cho NMI (Non-Maskable Interrupt), và các vector tiếp theo cho các ngắt khác.
- **Configurable**: Trong nhiều hệ thống, IVT có thể được cấu hình trong quá trình khởi tạo hệ thống để trỏ tới các ISR được định nghĩa trong firmware của bạn.
### Comparative analysis - interrupts-driven solutions versus polling-based solutions
## The STM32 EXTI peripheral
### Key features of the EXTI
- Cung cấp tối đa 23 line ngắt/sự kiện độc lập, trong đó có tối đa 16 line từ các chân GPIO, các line còn lại đến từ các tín hiệu nội bộ.
- Mỗi line có thể được cấu hình độc lập để hoạt động như ngắt (interrupt) hoặc sự kiện (event).
- Tùy chọn phát hiện cạnh cho từng line: cạnh lên (rising), cạnh xuống (falling), hoặc cả hai cạnh.
- Cờ trạng thái riêng cho từng line, dùng để chỉ ra ngắt/sự kiện đang chờ xử lý (pending).
- Khả năng tạo ngắt/sự kiện bằng phần mềm.


Việc cấu hình các line EXTI làm nguồn ngắt bao gồm 3 bước chính:
- **Configure mask bits**: Set mask bits  cho 23 interrupt lines sử dụng Interrupt Mask Register (EXTI_IMR).
- **Configure trigger selection bits**: Sử dụng Rising Trigger Selection Register (EXTI_RTSR) và Falling Trigger Selection Register (EXTI_FTSR) để chọn điều kiện kích hoạt mong muốn cho các line EXTI.
- **Enable the NVIC IRQ channel**: Cấu hình các bit enable và mask để điều khiển kênh NVIC IRQ được ánh xạ với EXTI. 
### External interrupt/ event line mapping
#### GPIO pins and EXTI lines
Mỗi chân GPIO trên vi điều khiển STM32 đều có thể được kết nối tới một line EXTI, cho phép nó tạo ra các ngắt ngoài. Sự linh hoạt này cho phép bạn kích hoạt ngắt cho bất kỳ chân GPIO nào, tuy nhiên có một điểm cần lưu ý: nhiều chân GPIO có thể dùng chung một line EXTI. Việc dùng chung này dựa trên số thứ tự của chân (pin number), chứ không dựa trên port.
- Pin 0 của mọi port đều được nối với EXTI0_IRQ
- Pin 1 của mọi port đều được nối với EXTI1_IRQ
- Pin 2 của mọi port đều được nối với EXTI2_IRQ
- ...


Điều này có nghĩa là tất cả các chân có cùng số pin ở các port khác nhau sẽ dùng chung một line EXTI.
Ví dụ: PA0, PB0, PC0, PD0, PE0 và PH0 đều được kết nối tới EXTI0.


**Lưu ý quan trọng**
- **Shared EXTI lines**: Vì nhiều chân dùng chung một line EXTI, nên không thể đồng thời bật ngắt cho hai chân có cùng số pin nhưng khác port. Ví dụ: nếu bạn đã bật ngắt cho PB0, thì bạn không thể bật ngắt cho PA0, vì cả hai cùng dùng EXTI0.
- **Configuration in SYSCFG_EXTICR**: Các thanh ghi SYSCFG_EXTICR (External Interrupt Configuration Register) được dùng để chọn chân của port nào sẽ được kết nối với một line EXTI cụ thể. Việc lựa chọn này đảm bảo rằng chỉ duy nhất một chân từ một port có thể là nguồn kích hoạt cho một line EXTI.
## Developing the EXTI driver
### EXTI_IMR
Sử dụng để EXTI_IMR để enable hoặc disable ngắt cho mỗi line EXTI.
### EXTI_RTSR
Thanh ghi EXTI_RTSR dùng để cấu hình kích hoạt theo cạnh lên cho từng line EXTI.
### EXTI_FTSR
Thanh ghi EXTI_FTSR được dùng để cấu hình kích hoạt theo cạnh xuống cho từng line EXTI.
### Pending Register (EXTI_PR)
Thanh ghi EXTI_PR cho biết những line EXTI nào đang có yêu cầu ngắt chờ xử lý (pending).
Thanh ghi này cũng được dùng để xóa ngắt pending bằng cách ghi giá trị 1 vào bit tương ứng.
### The EXTI driver
Links code: 

