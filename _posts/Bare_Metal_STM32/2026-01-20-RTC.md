---
title: "RTC"
date: 2026-01-20 05:38:00 +0700
categories: [Bare Metal STM32]
tags: [Bare Metal STM32]
---

# RTC

## How do RTCs work?
- **Crystal oscillator**: RTC chứa một bộ dao động tinh thể để tạo ra tín hiệu xung nhịp chính xác.
- **Counter**: Tín hiệu xung nhịp này được đưa vào bộ đếm. Bộ đếm sẽ tăng lên theo tốc độ được xác định bởi tần số của bộ dao động.
- **Time and date registers**: Giá trị của bộ đếm được sử dụng để cập nhật các thanh ghi thời gian và ngày tháng, nơi lưu trữ thời gian hiện tại (giờ, phút, giây) và ngày tháng (ngày, tháng, năm).
- **Battery backup**: Để đảm bảo hoạt động liên tục, RTC thường có pin dự phòng. Pin này giúp bộ dao động tiếp tục chạy và bộ đếm vẫn hoạt động ngay cả khi nguồn chính bị tắt.
## The key components of the STM32F4 RTC module
### Clock source
![frame](/assets/Bare_Metal_STM32/RTC/image.png)

- **Low-speed external (LSE)**: Bộ dao động tinh thể 32.768 kHz, nổi tiếng với độ ổn định cao và mức tiêu thụ điện năng thấp. Đây thường là nguồn xung được ưu tiên cho việc giữ thời gian chính xác.
- **Low-speed internal (LSI)**: Bộ dao động RC nội, cung cấp giải pháp tiện lợi khi không có tinh thể ngoài, nhưng độ chính xác kém hơn.
- **High-speed external (HSE)**: Nguồn xung tốc độ cao có thể được sử dụng, nhưng ít phổ biến trong các ứng dụng RTC do mức tiêu thụ điện năng cao hơn.


![frame](/assets/Bare_Metal_STM32/RTC/image1.png)
### Prescalers
- **Asynchronous prescaler (PREDIV)**: Bộ chia này thường được cấu hình chia cho 128, giúp giảm tần số xung nhịp xuống mức thấp hơn để bộ chia tần đồng bộ có thể xử lý. Nó giúp cân bằng giữa mức tiêu thụ điện năng và độ chính xác.
- **Synchronous prescaler (LSI)**: Thường được cấu hình chia cho 256, bộ chia này tiếp tục giảm tần số xung nhịp để tạo ra xung 1 Hz chính xác, điều này rất quan trọng cho việc cập nhật chính xác các thanh ghi thời gian và ngày tháng.
### Time and date registers
![frame](/assets/Bare_Metal_STM32/RTC/image2.png)
- **Time register (RTC_TR)**: Thanh ghi này lưu trữ thời gian hiện tại gồm giờ, phút và giây, được mã hóa theo định dạng BCD (Binary-Coded Decimal). Thanh ghi được cập nhật mỗi giây bởi xung 1 Hz tạo ra từ các bộ chia tần (prescaler).
- **Date register (RTC_DR)**: Thanh ghi này lưu trữ ngày tháng hiện tại, bao gồm năm, tháng và ngày, cũng ở định dạng BCD.
### Alarms
- **Alarm registers**: Mỗi báo thức có một tập thanh ghi riêng (RTC_ALRMAR và RTC_ALRMBR) dùng để lưu trữ thời gian và ngày tháng của báo thức.
- **Interrupts**: Khi báo thức được kích hoạt, nó có thể tạo ra một ngắt, đánh thức vi điều khiển khỏi chế độ tiết kiệm năng lượng hoặc khởi động một chức năng cụ thể.


![frame](/assets/Bare_Metal_STM32/RTC/image3.png)
### Wakeup timer
Bộ định thời tự nạp lại 16-bit (16-bit auto-reload timer) này có thể tạo ra các sự kiện đánh thức định kỳ, đưa hệ thống thoát khỏi các chế độ tiêu thụ năng lượng thấp theo những khoảng thời gian đều đặn. Nó rất phù hợp cho các tác vụ như đọc cảm biến hoặc kiểm tra hệ thống, giúp đảm bảo sử dụng năng lượng một cách hiệu quả.


![frame](/assets/Bare_Metal_STM32/RTC/image4.png)
### Backup and control registers
- **Backup registers**: Những thanh ghi này lưu trữ các dữ liệu quan trọng cần được giữ lại ngay cả khi nguồn chính bị tắt.
- **Control registers**: Các thanh ghi này (ví dụ như RTC_CR) dùng để quản lý việc cấu hình và vận hành RTC, bao gồm bật nguồn xung, cài đặt báo thức và cấu hình các sự kiện đánh thức.

### Output control
Mô-đun RTC có thể xuất ra các tín hiệu cụ thể, chẳng hạn như xung hiệu chuẩn (calibration clock) hoặc tín hiệu báo thức, thông qua chân RTC_AF1. Điều này cho phép mô-đun RTC tương tác với các linh kiện hoặc hệ thống khác, cung cấp các tín hiệu đồng bộ hoặc kích hoạt các sự kiện bên ngoài.

## Some key RTC registers
### RTC Time Register (RTC_TR)
Thanh ghi RTC_TR chịu trách nhiệm theo dõi thời gian hiện tại. Nó lưu trữ giờ, phút và giây dưới dạng BCD, giúp việc đọc và xử lý thời gian trở nên dễ dàng. Dưới đây là một số trường (field) quan trọng trong thanh ghi này:
- **Hàng chục giờ (HT) và hàng đơn vị giờ (HU)**: Các bit này lần lượt biểu diễn chữ số hàng chục và hàng đơn vị của giờ. Chúng hỗ trợ cả định dạng 24 giờ và 12 giờ.
- **Hàng chục phút (MNT) và hàng đơn vị phút (MNU)**: Các bit này biểu diễn chữ số hàng chục và hàng đơn vị của phút.
- **Hàng chục giây (ST) và hàng đơn vị giây (SU)**: Các bit này biểu diễn chữ số hàng chục và hàng đơn vị của giây.
- **PM**: Bit này dùng để chỉ AM/PM khi RTC hoạt động ở chế độ 12 giờ.
### RTC Date Register (RTC_DR)
Thanh ghi RTC_DR chịu trách nhiệm duy trì ngày tháng hiện tại. Nó theo dõi năm, tháng, ngày trong tháng và thứ trong tuần, tất cả đều được lưu trữ dưới dạng BCD.
- **Hàng chục năm (YT) và hàng đơn vị năm (YU)**: Các bit này biểu diễn chữ số hàng chục và hàng đơn vị của năm.
- **Hàng chục tháng (MT) và hàng đơn vị tháng (MU)**: Các bit này biểu diễn chữ số hàng chục và hàng đơn vị của tháng.
- **Hàng chục ngày (DT) và hàng đơn vị ngày (DU)**: Các bit này biểu diễn chữ số hàng chục và hàng đơn vị của ngày trong tháng.
- **Đơn vị thứ trong tuần (WDU)**: Trường này biểu diễn thứ trong tuần, với giá trị từ 1 đến 7.
### RTC Control Register (RTC_CR)
Thanh ghi RTC_CR là nơi điều khiển các chế độ hoạt động và tính năng khác nhau của RTC. Thanh ghi này cho phép chúng ta bật RTC, cấu hình báo thức và thiết lập bộ định thời đánh thức (wakeup timer).
- **WUTE**: Bật bộ định thời đánh thức. Bit này cho phép RTC wakeup timer hoạt động.
- **TSE**: Bật sự kiện dấu thời gian (timestamp). Bit này cho phép ghi lại dấu thời gian của các sự kiện.
- **ALRAE và ALRBE**: Bật Báo thức A và Báo thức B. Các bit này cho phép kích hoạt các báo thức tương ứng.
- **DCE**: Bật hiệu chuẩn số (digital calibration). Bit này cho phép hiệu chuẩn số cho xung nhịp RTC.
- **FMT**: Định dạng giờ. Bit này dùng để chọn định dạng 24 giờ hoặc 12 giờ (AM/PM).
### RTC Initialization and Status Register (RTC_ISR)
Thanh ghi RTC_ISR đảm nhiệm hai vai trò: vừa dùng để khởi tạo RTC, vừa dùng để giám sát trạng thái hoạt động của RTC. Thanh ghi này rất quan trọng trong quá trình thiết lập ban đầu cũng như khi kiểm tra trạng thái hiện tại của RTC. Dưới đây là các bit chính trong thanh ghi này:
- **INIT**: Chế độ khởi tạo. Khi thiết lập bit này, RTC sẽ được đưa vào chế độ initialization.
- **RSF**: Cờ đồng bộ thanh ghi. Bit này cho biết các thanh ghi lịch (calendar registers) đã được đồng bộ hay chưa.
- **INITS**: Cờ trạng thái khởi tạo. Bit này cho biết lịch RTC đã được khởi tạo hay chưa.
- **ALRAF và ALRBF**: Cờ báo thức A và báo thức B. Các bit này cho biết báo thức tương ứng đã được kích hoạt hay chưa.
### RTC Prescaler Register (RTC_PRER)
Thanh ghi RTC_PRER quản lý các bộ chia tần (prescaler) dùng để chia nguồn xung RTC nhằm tạo ra xung 1 Hz cần thiết cho việc giữ thời gian chính xác. Trong thanh ghi này có hai trường quan trọng:
- **PREDIV_A**: Bộ chia tần bất đồng bộ. Trường này dùng để thiết lập giá trị cho prescaler bất đồng bộ.
- **PREDIV_S**: Bộ chia tần đồng bộ. Trường này dùng để thiết lập giá trị cho prescaler đồng bộ.


Việc cấu hình đúng thanh ghi RTC_PRER là yếu tố then chốt để duy trì độ chính xác của RTC.
Tiếp theo, chúng ta sẽ tìm hiểu về các thanh ghi báo thức RTC, RTC_ALRMAR và RTC_ALRMBR.
### RTC Alarm Register (RTC_ALRMAR and RTC_ALRMBR)
Các thanh ghi này dùng để cấu hình Báo thức A và Báo thức B, cho phép chúng ta thiết lập những thời điểm cụ thể mà báo thức sẽ được kích hoạt. Dưới đây là các trường quan trọng trong những thanh ghi này:
- **ALRMASK**: Các bit mặt nạ báo thức. Những bit này cho phép bỏ qua (mask) một số phần của thời gian báo thức, mang lại sự linh hoạt trong cách thức và thời điểm báo thức được kích hoạt.
- **ALRH, ALRMN và ALRS**: Các trường giờ, phút và giây. Những trường này dùng để thiết lập thời điểm cụ thể cho báo thức.

### RTC Wakeup Register (RTC_WUTR)
Thanh ghi RTC_WUTR dùng để cấu hình bộ định thời đánh thức (wakeup timer), cho phép RTC định kỳ đánh thức hệ thống khỏi các chế độ tiêu thụ năng lượng thấp. Trường quan trọng nhất trong thanh ghi này là giá trị tự nạp lại của bộ đánh thức (WUT – Wakeup Auto-Reload Value). Trường này dùng để thiết lập khoảng thời gian giữa các lần đánh thức.

## Developing the RTC driver
Link: [RTC Driver](https://github.com/LooOnGit/Bare_Metal_STM/tree/c71cb099f097a5af533115efd9df87cf52d6615b)