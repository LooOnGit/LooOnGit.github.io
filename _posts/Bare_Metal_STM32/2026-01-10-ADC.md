---
title: "ADC"
date: 2026-01-10 09:06:06 +0700
categories: [Bare Metal STM32]
tags: [Bare Metal STM32]
---

# ADC

## Overview of analog-to-digital conversion
### What is analog-to-digital conversion?
Chuyển đổi tương tự sang số (Analog-to-Digital Conversion – ADC) là quá trình chuyển một tín hiệu tương tự liên tục thành dạng biểu diễn số rời rạc. Analog signal là cái mà có bất cứ giá trị nào trong phạm vi điện áp, chuyển đổi thành digital signal.

Quá trình chuyển đổi thường bao gồm một số bước chính: **lấy mẫu (sampling), lượng tử hóa (quantization) và mã hóa (encoding)**.

#### Sampling
Lấy mẫu (**Sampling**) là quá trình đo biên độ (**amplitude**) của tín hiệu analog tại các khoảng thời gian đều nhau, gọi là khoảng lấy mẫu (**sampling intervals**).


![Sampling](/assets/Bare_Metal_STM32/ADC/image.png)


Tốc độ lấy mẫu của analog signal được gọi là **sampling rate** hoặc **sampling frequency**. Được đo bằng số mẫu trên giây (Hz). Theo **Định lý Nyquist**, tần số lấy mẫu phải ít nhất gấp đôi tần số cao nhất có trong tín hiệu analog thì mới có thể tái tạo chính xác tín hiệu ban đầu.
#### Quantization
**Quantization** là quá trình map giá trị analog sample sang các mức rời rạc gần rất trong miền số. Mỗi mức rời rạc tương ứng với một mã số (digital core) duy nhất.


Số mức rời rạc dùng trong quá trình quantization thì được quyết định bởi **độ phân giải (resolution)** của bộ chuyển đổi ADC. Ví dụ, 8-bit ADC có 256 mức (2^8), trong khi ADC 12-bit ADC có 4096 mức (2^12).


Quá trình lượng tử hóa luôn tạo ra sai số, gọi là sai số lượng tử (quantization error) hoặc nhiễu lượng tử (quantization noise), vì giá trị analog thực tế chỉ được xấp xỉ về mức số gần nhất.
Ta có thể giảm sai số này bằng cách tăng độ phân giải của ADC.


Ví dụ: nếu tín hiệu analog nằm trong khoảng 0 đến 3.3 V và dùng ADC 8-bit, thì bước lượng tử (quantization step) xấp xỉ:


3.3V / 256 ≈ 12.9mV
	​

Một điện áp 1.5 V sẽ được làm tròn về mức số gần nhất, có thể cao hơn hoặc thấp hơn một chút so với 1.5 V. Bước cuối cùng trong quá trình là mã hóa (encoding).
#### Encoding
Encoding là quá trình cuối cùng và ở đó mức quantize được chuyển đổi thành một binary code để có thể xử lý bởi hệ thống digital.


Số bit được dùng trong ADC quyết định độ dài mã binary. Ví dụ, 10-bit ADC sẽ xử lý 10-bit mỗi giá trị sample. Tiếp tục nếu ứng với 1.5V được xác định là mức 116, thì biểu diễn nhị phân của nó trong ADC 8-bit sẽ là **01110100**.


![Encoding](/assets/Bare_Metal_STM32/ADC/image_1.png)

### Key specifications of the ADC - resolution, step size, and VREF
#### Resolution
Resolution của ADC  được quyết định số mức output rời rạc có thể xử lý, tương ứng với số khoảng điện áp vào được chia. Độ phân giải thường được biểu diễn bằng số bit. Độ phân giải càng cao thì khả năng biểu diễn chính xác tín hiệu tương tự (analog) càng tốt, giúp giảm sai số lượng tử hóa và tăng độ chính xác của phép đo.


Với **N-bit** ADC, số mức rời rạc là **2N**. Ví dụ, 8-bit ADC có 256 (2^8) mức, trong khi 12-bit ADC có 4096 mức.


![Resolution](/assets/Bare_Metal_STM32/ADC/image_2.png)
#### VREF
VREF là mức điện áp cao nhất để output ADC convert. Điện áp analog vào được so sánh với VREF để tạo ra giá trị digital. Độ ổn định và độ chính xác của VREF ảnh hưởng trực tiếp đến độ chính xác của ADC, vì bất kỳ sự dao động nào của VREF cũng sẽ gây ra sai số tương ứng ở đầu ra số.


Ta có thể chọn VREF nội từ vi điều khiển hoặc sử dụng VREF ngoài cho các ứng dụng cần độ chính xác cao. VREF nội thì tiện lợi nhưng thường dao động nhiều hơn, còn VREF ngoài thì ổn định và chính xác hơn. Việc chọn VREF phụ thuộc vào yêu cầu độ chính xác của ứng dụng và tính chất của tín hiệu analog đang đo.

Ví dụ, nếu VREF là 5V , ADC có thể chuyển đổ chính xác các tín hiệu analog trong khoảng 0V-5V.
#### Step size 
Step size là sự thay đổi nhỏ của tín hiệu analog ở đầu vào mà ADC có thể phân biệt được. Nó được tham chiếu VREF và độ phân giải ADC và độ phân giải của ADC, và quyết định độ mịn (granularity) của ADC output. Kích thước bước càng nhỏ thì độ phân giải càng cao, cho phép ADC phát hiện được những thay đổi rất nhỏ của tín hiệu đầu vào.


Step size được tính bằng cách chia VREF cho số mức rời rạc (2N).


Step size = VREF / 2^N


Ở đây, VREF là mức điện áp tham chiếu và N là số bit phân giải của ADC.


Cho ví dụ, có 10-bit ADC với VREF = 3.3V:


Step size = 3.3V / 2^10 = 3.3V / 1024 = 3.22mV


![Step size](/assets/Bare_Metal_STM32/ADC/image_3.png)


![Step size](/assets/Bare_Metal_STM32/ADC/image_4.png)



## The STM32F4 adc Peripheral
ADC trên STM32F411 có 12-bit mỗi channel, nó có từ 9-12 channel. ADC có thể hoạt động nhiều mode chẳng hạn như signal, continuous, scan hoặc discontinuous, với kết quả chứa trong 16-bit data register. Bổ sung thêm, ADC có tính năng analog watchdog cho phép hệ thống phát hiện khi điện áp vào vượt ngưỡng xác định trước.

### The ADC channels
Kênh ADC (ADC channel) là một đường dẫn riêng mà qua đó tín hiệu analog được đưa vào ADC để được chuyển đổi sang giá trị số. Mỗi kênh ADC tương ứng với một chân GPIO cụ thể được cấu hình ở chế độ analog.
#### Multiplexing ADC channels
Multiplexing ADC channels cho phép ADC switch giữa nhiều input khác vào, sampling mỗi phần. Để đạt được sử dụng một ananlog multiplexer (MUX) trong ADC peripheral.


![MUX ADC](/assets/Bare_Metal_STM32/ADC/image_5.png)
#### The ADC modes
- **Signal conversion mode**: Trong mode này, ADC thực hiện chuyển đổi duy nhất trên kênh đã chọn rồi dừng lại. Mode này sử dụng những ứng dụng cho lấy mẫu theo chu kỳ hoặc theo sự kiện theo yêu cầu. Để chọn mode , chúng ta cần set CONT bit trong để 0 trong ADC_CR2 register.
- **Continuous conversion mode**: Cho phép ADC lặp lại convert input signal. Sau khi mỗi conversion, tiếp theo nó sẽ bắt đầu tự động. Mode này cho phép setting CONT bit để 1 trong ADC_CR2 register. Ví dụ như: Hiển thị liên tục giá trị biến trở real time.
- **Scan mode**: Chế độ này được dùng để chuyển đổi một chuỗi các kênh analog. Ta sử dụng chế độ này khi cần lấy mẫu nhiều tín hiệu theo một thứ tự xác định. Mode này cho phép setting SCAN bit trong thanh ghi ADC_CR1 và sau đó cấu hình thứ tự các kênh trong thanh ghi ADC_SQRx register. Nếu CONT bit set trong ADC_CR2 thì mode này lặp lại sau khi kênh cuối đã convert xong.


**Ví dụ:** Sampling multiple sensor inputs trong một hệ thống thu thập dữ liệu.
- **Discontinuous mode**: Mode này chon phép convert một subset của những channel trong một chuỗi quét. Nó giúp giảm số lượng kênh được chuyển đổi trong mỗi chuỗi, rất hữu ích cho việc tiết kiệm năng lượng hoặc giảm tải xử lý. Chế độ này được kích hoạt bằng cách đặt bit DISCEN trong thanh ghi ADC_CR1, sau đó xác định số kênh cần chuyển đổi trong mỗi nhóm bằng cách đặt các bit DISCNUM cũng trong ADC_CR1.


**Ví dụ:** Giảm tần số lấy mẫu cho một tập con các kênh trong hệ thống nhiều kênh.
- **Injected conversion mode**: Chế độ này được thiết kế cho các phép đo ưu tiên cao, có thể ngắt các phép chuyển đổi thông thường. Nó rất hữu ích trong những ứng dụng cần độ chính xác về thời gian cho một số tín hiệu quan trọng. Ta sử dụng chế độ này bằng cách cấu hình các kênh injected và thứ tự của chúng trong thanh ghi ADC_JSQR, sau đó bắt đầu quá trình chuyển đổi bằng cách: đặt bit JSWSTART trong ADC_CR2, hoặc sử dụng tín hiệu kích hoạt ngoài (external trigger).


**Ví dụ:** Ưu tiên đo điện áp các cell quan trọng trong hệ thống quản lý pin (BMS) khi pin đang sạc nhanh hoặc xả nhanh.
### Understanding regular channels versus injected channels in STM32F411 ADC
Trong vi điều khiển STM32F411, ADC cung cấp một cách tiếp cận linh hoạt để xử lý nhiều ngõ vào analog thông qua hai loại kênh chính: kênh regular (thường) và kênh injected (ưu tiên).


Kênh regular được cấu hình cho các phép chuyển đổi tuần tự, thông thường, rất phù hợp cho việc thu thập dữ liệu định kỳ từ cảm biến khi yêu cầu về thời gian không quá khắt khe. Các kênh này tuân theo một chuỗi xác định trước được thiết lập trong các thanh ghi ADC_SQRx và có thể được kích hoạt bằng phần mềm hoặc bằng sự kiện bên ngoài.


Ngược lại, các kênh injected (ví dụ như khi cấu hình ở injected conversion mode) được thiết kế cho các tác vụ ưu tiên cao và nhạy về thời gian. Chúng có thể ngắt chuỗi chuyển đổi regular để thực hiện chuyển đổi ngay lập tức khi các điều kiện cụ thể được thỏa mãn. Điều này làm cho kênh injected rất phù hợp để bắt các phép đo quan trọng với độ chính xác thời gian cao, chẳng hạn như đo dòng động cơ trong các ứng dụng điều khiển.


Ngoài ra, ADC còn có tính năng Analog Watchdog, cho phép giám sát cả kênh regular và injected để phát hiện khi giá trị vượt quá ngưỡng đã định trước, từ đó tạo ngắt để xử lý các tình huống vượt giới hạn. Khả năng hai loại kênh (regular + injected) kết hợp với Analog Watchdog tạo nên một khung làm việc mạnh mẽ cho nhiều ứng dụng, từ giám sát môi trường định kỳ cho đến xử lý dữ liệu thời gian thực quan trọng và giám sát an toàn. Trong phần tiếp theo, chúng ta sẽ xem xét các thanh ghi quan trọng của ngoại vi ADC và một số cờ (flags) liên quan đến hoạt động của ADC.

## The key ADC register and flags
### ADC Control Register (ADC_CR1)
Nó cung cấp cấu hình nhiều options, chẳng hạn resolution, scan mode, discontinuous mode, nad interrupt mode.
- **RES[1:0]** (resolution bits): bit này set resolution của ADC (12-bit, 10-bit, 8-bit, hoặc 6-bit).
- **SCAN** (scan mode): Set bit này cho phép scan mode, cho phép ADC chuyển đổi multiple channel theo thứ tự.
- **DISCEN (discontinuous mode)**: Khi set, bit này cho phép discontinuous mode trên regular channel.
- **AWDEN** (Analog Watchdog enable): Bit này cho phép Analog Watchdog trên tất cả regular channel.
- **EOCIE** (end of conversion interrupt enable): Khi set, bit này cho phép ngắt được tạo ra để tạo ra khi EOC flag được set.
### ADC Control Register (ADC_CR2)
Đây là một thanh ghi điều khiển quan trọng khác dùng để quản lý nhiều khía cạnh hoạt động của ADC, bao gồm bắt đầu quá trình chuyển đổi, căn chỉnh dữ liệu (data alignment) và các tín hiệu kích hoạt bên ngoài (external triggers).
- **ADON (ADC on)**: Bit này bật ADC on hoặc off.
- **CONT (continuous conversion)**: Setting bit này cho phép mode chuyển đổi liên tục.
- **SWSTART (software start)**: Setting bit này bắt đầu chuyển đổi của regular channels.
- **ALIGN (data alignment)**: Bit này set alignment của converted data (right or left).
- **EXTEN [1:0]**: Đây là trigger bên ngoài (external trigger) cho các kênh regular, cho phép chọn polarity cho regular channel.
### ADC Regular Sequence Register (ADC_SQRx)
Các thanh ghi ADC_SQRx dùng để xác định thứ tự (sequence) mà ADC sẽ chuyển đổi các kênh.
Có nhiều thanh ghi SQR để quản lý chuỗi chuyển đổi cho tối đa 16 kênh regular.
- **L[3:0]**: Regular channel sequence length. Bit này set tổng số lần chuyển đổi chuỗi regular.
- **SQ1-SQ16**: Regular channel sequence. Bit này xác định thứ tự các kênh sẽ được chuyển đổi.
### ADC Data Register (ADC_DR)
ADC_DR chứa giá trị đã chuyển đổi sau khi chuyển đổi hoàn tất.
### ADC Status Register (ADC_SR)
Register này chứa các bit status để thông báo về các trạng thái của ADC.
### The key ADC flags
ADC flag là trạng thái hoạt động của ADC. 
- **End of conversion (EOC)**: EOC flag chỉ định rằng ADC hoàn thành quá trình chuyển đổi. Nếu bit EOCIE trong thanh ghi ADC_CR1 được bật, cờ EOC có thể kích hoạt ngắt. Flag này nằm trong thanh ghi ADC_SR, tại bit 1 (EOC) và được phần cứng tự động set khi một lần chuyển đổi regular kết thúc. Khi đó, hàm ngắt (ISR) sẽ được gọi để xử lý dữ liệu ADC vừa chuyển đổi.
- **End of injected conversion (JEOC) flag**: Flag JEOC cho biết toàn bộ chuỗi chuyển đổi injected đã hoàn thành và kết quả đã có trong thanh ghi dữ liệu injected. Flag này nằm trong ADC_SR, tại bit 2 (JEOC) và được phần cứng set khi tất cả các kênh injected trong nhóm đã được chuyển đổi xong. Tương tự EOC, nếu bit JEOCIE trong ADC_CR1 được bật thì cờ JEOC cũng có thể tạo ngắt..
- **Analog Watchdog (AWD) flag**: Cờ AWD cho biết giá trị ADC đo được vượt quá ngưỡng trên hoặc dưới đã cấu hình cho Analog Watchdog. Cờ này nằm trong ADC_SR, tại bit 0 (AWD). Nếu bit AWDIE trong ADC_CR1 được bật, cờ này cũng sẽ kích hoạt ngắt khi tín hiệu vượt ngưỡng.
- **Overrun (OVR) flag**: Flag OVR cho biết kết quả chuyển đổi mới đã ghi đè lên kết quả cũ trước khi CPU kịp đọc dữ liệu. Flag này nằm trong ADC_SR, tại bit 5 (OVR). Nếu bit OVRIE trong ADC_CR1 được bật, cờ này cũng sẽ tạo ngắt báo lỗi tràn dữ liệu.
- **Start conversion (STRT) flag**: Flag STRT cho biết ADC đã bắt đầu quá trình chuyển đổi.
Ta có thể dùng flag này để kiểm tra xem ADC đã thực sự bắt đầu convert hay chưa.
## Developing the ADC driver 
1. Initializes the ADC GPIO pin:
- Enables the clock for GPIOA
- Sets PA1 to analog mode
2. Configures the ADC module:
- Enables the clock for ADC1
- Sets channel 1 as the start of the conversion sequence
- Sets the conversion sequence’s length to 1
- Enables the ADC module
3. Starts the ADC conversion process:
- Enables continuous conversion mode
- Starts the ADC conversion process
4. Reads the ADC value:
- Waits for the conversion to complete
- Reads the converted value from the ADC data register
Links code: [ADC Driver](https://github.com/LooOnGit/Bare_Metal_STM/tree/5064e2ac02ae842dc34e371c82ebf463317e939f)