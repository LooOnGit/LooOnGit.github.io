---
title: "I2C"
date: 2026-01-16 21:57:41 +0700
categories: [Bare Metal STM32]
tags: [Bare Metal STM32]
---

# I2C

## An overview of the I2C protocol
### What is I2C?
I2C là một bus truyền thông nối tiếp, một đầu (single-ended), chuyển mạch theo gói (packet-switched), hỗ trợ đa master – đa slave, được phát minh bởi Philips Semiconductor (nay là NXP Semiconductors). Giao thức này được thiết kế cho việc truyền thông khoảng cách ngắn, trong phạm vi một thiết bị hoặc giữa nhiều thiết bị trên cùng một bo mạch.
#### The key features of I2C
I2C có nhiều đặc điểm độc đáo, khiến nó trở nên lý tưởng cho nhiều ứng dụng trong các hệ thống nhúng:
- **A two-wire interface**: I2C chỉ sử dụng 2 dây, **Serial Data (SDA)** và **Serial Clock (SCL)**, giúp đơn giản hóa việc đi dây và giảm số lượng chân cần thiết trên vi điều khiển. 
- **Multi-master and multi-slave**: Nhiều thiết bị master có thể khởi tạo giao tiếp trên bus, và nhiều thiết bị slave có thể phản hồi. Tính linh hoạt này cho phép xây dựng các cấu hình truyền thông phức tạp. Giao thức I2C hỗ trợ tối đa 128 thiết bị với địa chỉ 7-bit, tuy nhiên giới hạn thực tế là 119 thiết bị do một số địa chỉ được dành riêng. Với địa chỉ 10-bit, về mặt lý thuyết giao thức cho phép 1.024 thiết bị, nhưng các địa chỉ dành riêng cũng làm giảm nhẹ số lượng tối đa có thể sử dụng. Chế độ 10-bit tuy ít phổ biến hơn nhưng cho phép kết nối nhiều thiết bị hơn trên cùng một bus.
- **Address device**: Mỗi device trên I2C có một địa chỉ duy nhất, cho phép master giao tiếp với device cụ thể. Địa chỉ này có thể là 7-bit hoặc 10-bit.
- **Synchronous communication**: SCL cung cấp clock signal, đảm bảo rằng data được truyền và nhận đồng bộ giữa master và slave.
- **Speed variants**: I2C hỗ trợ nhiều speed mode, bao gồm standard mode (100kbps), fast mode (400kbps), fast mode plus (1Mbps), high speed mode (3.4Mbps) và các yêu cầu speed khác.
- **Simple and low cost**: Giao thức đơn giản và hardware nhỏ khi yêu cầu về giá.
#### The I2C interface
- **Serial Data (SDA)**: Đường này mang data giữa những device.
- **Seriak Clock(SCL)**: Đường này mang clock signal tạo ra từ master.


![I2C](/assets/Bare_Metal_STM32/I2C/image.png)


2 đường này để kết nối tất cả thiết bị trên đường bus, với pull-up resistor đảm bảo rằng kéo lên mức high khi trạng thái idle.
#### How I2C works
- **Master device**: Master device khởi tạo giao tiếp và tạo xung clock. Nó điều khiển flow của data và có thể address của multi-slave.
- **Slave device**: Thiết bị slave phản hồi các lệnh từ master và thực hiện các thao tác được yêu cầu. Mỗi slave có một địa chỉ duy nhất 7-bit hoặc 10-bit mà master sử dụng để nhận dạng thiết bị.


Giao tiếp theo như sau:
- **1. A start condition**: Giao tiếp bắt đàu với master tạo ra điều kiện bắt đầu. Kéo SDA xuống mức Low trong khi SCL là high.
- **2. Address frame**: Master gửi address của slave device target, read/write bit chỉ định hoạt động type (0 cho write và 1 cho read).
- **3. Acknowledge (ACK) bit**: Address slave phản hồi với một ACK bit bằng kéo SDA xuống low trong lúc clock pulse tiếp theo.
- **4. Data Frames**: Data thì truyền 8-bit frame. Mỗi byte theo 1 ACK bit từ bên nhận.
- **5. A stop condition**: Master end giao tiếp bằng tạo một stop condition, nó kéo high trong khi SCL line đang mức cao.


![frame](/assets/Bare_Metal_STM32/I2C/image2.png)


- **Write operation**: Master gửi một start condition, **addressframe** với write bit, và data frame.
- **Read operation**: Master gửi một start condition, address frame với read bit, và sau đó đọc data frame từ slave. Mỗi byte dữ liệu được master xác nhận bằng bit ACK, ngoại trừ byte cuối cùng sẽ được theo sau bởi bit NACK để báo hiệu kết thúc quá trình đọc.


![frame](/assets/Bare_Metal_STM32/I2C/start.png)


![frame](/assets/Bare_Metal_STM32/I2C/stop.png)


![frame](/assets/Bare_Metal_STM32/I2C/data.png)


![frame](/assets/Bare_Metal_STM32/I2C/frame.png)

## The STM32 peripheral
### The key I2C registers
#### I2C Control Register 1 (I2C_CR1)
I2C_CR1 thì chủ yếu là thanh ghi điều khiển sử dụng để config I2C peripheral. Nó cung cấp option để enable peripheral, quản lý start và stop condition và control acknowledge feature.
- **Peripheral enable (PE)**: Bit này enable hoặc disable.
- **Start generation (START)**: Set bit START, khởi tạo giao tiếp.
- **Stop generation (STOP)**: Set bit STOP, kết thúc giao tiếp.
- **Acknowledge enable (ACK)**: Khi set, bit này enable ACK sau khi mới byte nhận.
- **Acknowledge/PEC position (POS)**: Bit này điều khiển position của ACK bit.
- **Software reset (SWRST)**: Set bit này reset I2C peripheral.

#### I2C Control Register 2 (I2C_CR2)
I2C_CR2 là một thanh ghi điều khiển quan trọng khác, dùng để xử lý nhiều khía cạnh khác nhau của hoạt động I2C, bao gồm tần số clock, cho phép ngắt, và điều khiển DMA. Các bit quan trọng trong thanh ghi này bao gồm:
- **FREQ[5:0] (peripheral clock frequency)**: Bit này set I2C peripheral clock frequency ở MHz.
- **DMAEN (cho phép yêu cầu DMA)**: Khi bit này được set, nó sẽ kích hoạt các yêu cầu DMA cho ngoại vi I2C.

#### I2C Clock Control Register (I2C_CCR)
I2C_CCR configures clock set standard, fast, và fast mode plus.
- **CCR[11:0] (clock control)**: Bit này set clock control value, xác định tốc độ clock.
- **DUTY (fast mode duty mode)**: Bit này select duty cycle để fast mode.
- **F/S (I2C master mode selection)**: Bit này select giữa standard mode (0) và fast mode (1).
#### I2C TRISE register (I2C_TRISE)
I2C_TRISE dùng để cấu hình thời gian sườn lên tối đa (maximum rise time) cho các tín hiệu I2C, nhằm đảm bảo tuân thủ chuẩn I2C.


Thanh ghi này chỉ có một trường duy nhất:


- **TRISE[5:0] (thời gian sườn lên tối đa):** Các bit này dùng để thiết lập thời gian sườn lên tối đa cho các tín hiệu SDA và SCL, tính bằng nanosecond (ns).
#### I2C Data Register (I2C_DR)
I2C_DR là thanh ghi dữ liệu được sử dụng cho cả truyền và nhận dữ liệu. Dữ liệu được ghi vào thanh ghi này sẽ được truyền đi, và dữ liệu nhận từ bus sẽ được lưu trữ trong thanh ghi này.


Thanh ghi này chỉ có một trường duy nhất:


- **DR[7:0] (thanh ghi dữ liệu 8-bit):** Thanh ghi này chứa dữ liệu 8-bit cần truyền hoặc dữ liệu nhận được từ bus.
## Developing the I2C driver
Links code: [i2c Driver](https://github.com/LooOnGit/Bare_Metal_STM/tree/de3eb3da7ba02f959eddefce83b363a6aea81c9a)