---
title: "GPIO STM32"
date: 2025-12-16 09:19:34 +0800
categories: [Bare Metal STM32]
tags: [Bare Metal STM32]
---

# ğŸ“š STM32 GPIO Programming Guide

## ğŸ“Œ 1. Giá»›i thiá»‡u vá» GPIO

**GPIO (General Purpose Input/Output)** lÃ  cÃ¡c chÃ¢n vÃ o/ra Ä‘a nÄƒng trÃªn vi Ä‘iá»u khiá»ƒn STM32, cho phÃ©p tÆ°Æ¡ng tÃ¡c vá»›i tháº¿ giá»›i bÃªn ngoÃ i.

### ğŸ—ºï¸ Memory Map

![Memory Map](/assets/Bare_Metal_STM32/GPIO/image_memory_map.png)

Tá»« memory map cÃ³ thá»ƒ tháº¥y **peripherals** náº±m tá»« vÃ¹ng nhá»› `0x40000000` Ä‘áº¿n `0x5FFFFFFF`. 
- **Peripheral base address**: `0x40000000`
- ÄÆ°á»£c phÃ¢n ra thÃ nh nhiá»u block: APB1, APB2, AHB1, AHB2, Cortex-M4 internal peripheral

> [!NOTE]
> **Advanced Peripheral Bus (APB)**: Giao tiáº¿p tá»‘c Ä‘á»™ tháº¥p  
> **Advanced High-Performance Bus (AHB)**: Giao tiáº¿p tá»‘c Ä‘á»™ cao

### âœ¨ 1.1 Äáº·c Ä‘iá»ƒm cá»§a GPIO STM32

- âš™ï¸ CÃ³ thá»ƒ cáº¥u hÃ¬nh lÃ  **input** hoáº·c **output**
- ğŸ”Œ Há»— trá»£ **pull-up/pull-down**
- âš¡ Tá»‘c Ä‘á»™ Ä‘áº§u ra cÃ³ thá»ƒ Ä‘iá»u chá»‰nh
- ğŸ”„ Chá»©c nÄƒng **alternate function**
- ğŸ¯ **Interrupt/Event handling**

### ğŸ—ï¸ 1.2 Cáº¥u trÃºc GPIO Port

**VÃ­ dá»¥:** Trong báº£ng nÃ y mÃ¬nh cáº§n tÃ¬m `GPIOA` thÃ¬ tÃ¬m Ä‘á»‹a chá»‰ cá»§a nÃ³ xem nÃ³ phá»¥ thuá»™c vÃ o bus nÃ o.

![GPIO Port Structure](/assets/Bare_Metal_STM32/GPIO/Boundary_addres.png)

á» Ä‘Ã¢y ta tháº¥y **GPIOA** Ä‘ang Ä‘Æ°á»£c phÃ¢n chia Ä‘á»‹a chá»‰ tá»« `0x4000 0000` Ä‘áº¿n `0x4002 03FF`. 

```
Address = Peripheral Base Address + Offset
        = 0x40000000 + 0x20000
```

Pháº§n `0x20000` Ä‘Æ°á»£c gá»i lÃ  **offset value**.

### â° 1.3 Clock

> [!IMPORTANT]
> Clock cung cáº¥p pulse chung Ä‘á»ƒ Ä‘á»“ng bá»™ hoáº¡t Ä‘á»™ng cá»§a microcontroller.  
> **Khi dÃ¹ng báº¥t cá»© peripheral nÃ o pháº£i cáº¥p xung clock trÆ°á»›c!**

![GPIO Port Structure](/assets/Bare_Metal_STM32/GPIO/Boundary_addres.png)

Trong báº£ng nÃ y **RCC (Reset and Clock Control)** náº±m tá»« address `0x4002 3800` Ä‘áº¿n `0x4002 3BFF`.

### ğŸ“ 1.4 Quy táº¯c Ä‘áº·t tÃªn thanh ghi

CÃ¡c thanh ghi trong STM32 tuÃ¢n thá»§ theo quy táº¯c:

```
PERIPHERAL_ACRONYM + UNDERSCORE + REGISTER_ACRONYM
```

**Peripheral acronym** - Viáº¿t táº¯t tÃªn cá»§a ngoáº¡i vi:
- `GPIO` â†’ General Purpose Input/Output
- `USART` â†’ Universal Synchronous/Asynchronous Receiver Transmitter
- `TIM` â†’ Timer
- `ADC` â†’ Analog-to-Digital Converter

**Register acronym** - Viáº¿t táº¯t cá»§a thanh ghi:
- `CR` â†’ Control Register
- `SR` â†’ Status Register
- `DR` â†’ Data Register
- `BRR` â†’ Baud Rate Register

**VÃ­ dá»¥ káº¿t há»£p:**
- `GPIOA_MODER` â†’ Register MODER cá»§a peripheral GPIOA
- `USART1_SR` â†’ Status Register cá»§a USART1
- `TIM2_CR1` â†’ Control Register 1 cá»§a Timer 2

---

## ğŸ”§ 2. Thao tÃ¡c vá»›i thanh ghi

### âœ… Setting bit
Sá»­ dá»¥ng toÃ¡n tá»­ **OR**
```c
register |= (1 << position);
```

### âŒ Clear bit
Sá»­ dá»¥ng toÃ¡n tá»­ **AND**
```c
register &= ~(1 << position);
```

---

## ï¿½ 3. Cáº¥u hÃ¬nh GPIO Output

### ğŸ¯ 3.1 Enable Clock (AHB1ENR)

> [!TIP]
> Äáº§u tiÃªn khi Ä‘iá»u khiá»ƒn GPIO thÃ¬ pháº£i cÃ³ clock. TÃ¬m **RCC** Ä‘áº¿n **AHB1ENR** Ä‘á»ƒ cáº¥p clock cho bus AHB1.

```c
#define PERIPH_BASE         (0x40000000UL)  // 1: Define base address for peripherals
#define AHB1PERIPH_OFFSET   (0x00020000UL)  // 2: Offset for AHB1 peripheral bus
#define AHB1PERIPH_BASE     (PERIPH_BASE + AHB1PERIPH_OFFSET) // 3: Base address for AHB1 peripherals
```

### ğŸ”„ 3.2 RCC (Reset and Clock Control)

```c
#define RCC_OFFSET          (0x00003800UL)                      // 6: Offset for RCC
#define RCC_BASE            (AHB1PERIPH_BASE + RCC_OFFSET)      // 7: Base address for RCC
```

### âš™ï¸ 3.3 Mode Register (MODER)

```c
#define GPIOD_OFFSET        (0x00000C00UL)                      // 4: Offset for GPIOD
#define GPIOD_BASE          (AHB1PERIPH_BASE + GPIOD_OFFSET)    // 5: Base address for GPIOD
#define MODER_OFFSET        (0x00UL)                            // 10: Offset for mode register
#define GPIOD_MODER         (*(volatile unsigned int *)(GPIOD_BASE + MODER_OFFSET)) // 11: Address of GPIOD mode register
```

### ğŸ“¤ 3.4 Data Output Register (ODR)

```c
#define ODR_OFFSET          (0x14UL)                            // 12: Offset for output data register
#define GPIO_ODR            (*(volatile unsigned int *)(GPIOD_BASE + ODR_OFFSET))   // 13: Address of GPIOD output data register
```

### ğŸ“ 3.5 Set Pin Output

```c
#define PIN_12              (1U << 12)  // 15: Bit mask for GPIOD pin 12
#define LED_1               PIN_12      // 16: Alias for PIN12 representing LED pin
```

---

## ğŸš€ 4. VÃ­ dá»¥ hoÃ n chá»‰nh

### ğŸ’¡ 4.1 Blink LED trÃªn GPIOD Pin 12

```c
#include <stdint.h>

// ğŸ  Base Addresses
#define PERIPH_BASE         (0x40000000UL)                      // 1: Define base address for peripherals
#define AHB1PERIPH_OFFSET   (0x00020000UL)                      // 2: Offset for AHB1 peripheral bus
#define AHB1PERIPH_BASE     (PERIPH_BASE + AHB1PERIPH_OFFSET)   // 3: Base address for AHB1 peripherals

// ğŸ“ GPIO Port D
#define GPIOD_OFFSET        (0x00000C00UL)                      // 4: Offset for GPIOD
#define GPIOD_BASE          (AHB1PERIPH_BASE + GPIOD_OFFSET)    // 5: Base address for GPIOD

// â° RCC (Reset and Clock Control)
#define RCC_OFFSET          (0x00003800UL)                      // 6: Offset for RCC
#define RCC_BASE            (AHB1PERIPH_BASE + RCC_OFFSET)      // 7: Base address for RCC

// ğŸ“Š Registers
#define AHB1EN_R_OFFSET     (0x30UL)                            // 8: Offset for AHB1EN register
#define RCC_AHB1EN_R        (*(volatile unsigned int *)(RCC_BASE + AHB1EN_R_OFFSET)) // 9: Address of AHB1EN Register

#define MODER_OFFSET        (0x00UL)                            // 10: Offset for mode register
#define GPIOD_MODER         (*(volatile unsigned int *)(GPIOD_BASE + MODER_OFFSET)) // 11: Address of GPIOD mode register

#define ODR_OFFSET          (0x14UL)                            // 12: Offset for output data register
#define GPIO_ODR            (*(volatile unsigned int *)(GPIOD_BASE + ODR_OFFSET))   // 13: Address of GPIOD output data register

// ğŸ¯ Pin Definitions
#define GPIOD_EN            (1U << 3)   // 14: Bit mask for enabling GPIOD (bit 3)
#define PIN_12              (1U << 12)  // 15: Bit mask for GPIOD pin 12
#define LED_1               PIN_12      // 16: Alias for PIN12 representing LED pin

int main(void)
{
    // â° Enable clock for GPIOD
    RCC_AHB1EN_R |= GPIOD_EN;

    // âš™ï¸ Configure Pin 12 as output (01)
    GPIOD_MODER &= ~(3U << (12 * 2));  // Clear bits 24-25
    GPIOD_MODER |=  (1U << (12 * 2));  // Set bit 24 to 1, bit 25 to 0

    // ğŸ’¡ Turn ON LED
    while (1)
    {
        GPIO_ODR |= LED_1;   // PD12 ON
    }
}
```

---

## ğŸ“– 5. Giáº£i thÃ­ch cÃ¡c khÃ¡i niá»‡m quan trá»ng

### ğŸ”¤ 5.1 Háº­u tá»‘ `UL`

```c
#define PERIPH_BASE (0x40000000UL)
```

> [!NOTE]
> Háº­u tá»‘ `UL` (Unsigned Long) cho phÃ©p compiler hiá»ƒu ráº±ng giÃ¡ trá»‹ lÃ  má»™t sá»‘ **khÃ´ng dáº¥u** (unsigned) vÃ  cÃ³ kÃ­ch thÆ°á»›c **32 bit**.  
> Náº¿u khÃ´ng cÃ³ `UL` thÃ¬ máº·c Ä‘á»‹nh lÃ  `Unsigned Int`.

### âš ï¸ 5.2 Tá»« khÃ³a `volatile`

```c
#define GPIOD_MODER (*(volatile unsigned int *)(GPIOD_BASE + MODER_OFFSET))
```

> [!IMPORTANT]
Náº¿u khÃ´ng sá»­ dá»¥ng volatile, compiler cÃ³ thá»ƒ tá»‘i Æ°u hÃ³a báº±ng cÃ¡ch loáº¡i bá» má»™t sá»‘ thao tÃ¡c Ä‘á»c hoáº·c ghi vÃ o cÃ¡c Ä‘á»‹a chá»‰ nÃ y, do giáº£ Ä‘á»‹nh ráº±ng giÃ¡ trá»‹ cá»§a chÃºng khÃ´ng thay Ä‘á»•i má»™t cÃ¡ch báº¥t ngá».Äiá»u nÃ y xáº£y ra vÃ¬ trong quÃ¡ trÃ¬nh biÃªn dá»‹ch, compiler luÃ´n tÃ¬m cÃ¡ch lÃ m cho chÆ°Æ¡ng trÃ¬nh cháº¡y hiá»‡u quáº£ hÆ¡n, bao gá»“m viá»‡c loáº¡i bá» cÃ¡c thao tÃ¡c dÆ° thá»«a hoáº·c Ä‘Æ¡n giáº£n hÃ³a luá»“ng thá»±c thi. QuÃ¡ trÃ¬nh nÃ y diá»…n ra táº¡i thá»i Ä‘iá»ƒm biÃªn dá»‹ch, trÆ°á»›c khi chÆ°Æ¡ng trÃ¬nh Ä‘Æ°á»£c cháº¡y.

Náº¿u compiler suy luáº­n ráº±ng má»™t biáº¿n (bao gá»“m cáº£ thanh ghi pháº§n cá»©ng Ä‘Æ°á»£c Ã¡nh xáº¡ vÃ o bá»™ nhá»›) khÃ´ng bá»‹ thay Ä‘á»•i trong luá»“ng chÆ°Æ¡ng trÃ¬nh mÃ  nÃ³ â€œnhÃ¬n tháº¥yâ€, thÃ¬ nÃ³ cÃ³ thá»ƒ tá»‘i Æ°u báº±ng cÃ¡ch loáº¡i bá» cÃ¡c láº§n Ä‘á»c/ghi láº·p láº¡i.

VÃ­ dá»¥, náº¿u má»™t giÃ¡ trá»‹ Ä‘Æ°á»£c Ä‘á»c tá»« má»™t thanh ghi vÃ  sau Ä‘Ã³ láº¡i Ä‘Æ°á»£c Ä‘á»c láº§n ná»¯a, compiler cÃ³ thá»ƒ giáº£ Ä‘á»‹nh ráº±ng giÃ¡ trá»‹ Ä‘Ã³ khÃ´ng thay Ä‘á»•i vÃ  sá»­ dá»¥ng láº¡i giÃ¡ trá»‹ Ä‘Ã£ Ä‘á»c trÆ°á»›c Ä‘Ã³, thay vÃ¬ truy cáº­p láº¡i vÃ o thanh ghi.

Viá»‡c sá»­ dá»¥ng tá»« khÃ³a volatile lÃ  má»™t chá»‰ thá»‹ cho compiler biáº¿t ráº±ng khÃ´ng Ä‘Æ°á»£c Ã¡p dá»¥ng cÃ¡c kiá»ƒu tá»‘i Æ°u hÃ³a nÃ y Ä‘á»‘i vá»›i biáº¿n Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u, nháº±m Ä‘áº£m báº£o ráº±ng má»—i láº§n truy cáº­p Ä‘á»u thá»±c sá»± Ä‘á»c/ghi trá»±c tiáº¿p vÃ o thanh ghi pháº§n cá»©ng, giá»¯ nguyÃªn tÃ­nh Ä‘Ãºng Ä‘áº¯n cá»§a cÃ¡c thao tÃ¡c.

### ğŸ­ 5.3 Bit Mask

```c
#define GPIOD_EN (1U << 3)  // Bit mask for enabling GPIOD
```

> [!TIP]
> **Bit mask** lÃ  má»™t binary number Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ thay Ä‘á»•i giÃ¡ trá»‹ cá»§a má»™t thanh ghi.  
> CÃ¡c bitwise operations: **AND**, **OR**, **NOT**, **XOR**.

### ğŸ·ï¸ 5.4 Alias

```c
#define LED_1 PIN_12  // Alias for PIN12 representing LED pin
```

> [!NOTE]
> **Alias** lÃ  má»™t tÃªn khÃ¡c cho má»™t bit/group of bits Ä‘á»ƒ dá»… dÃ ng Ä‘á»c vÃ  dá»… hiá»ƒu.  
> VÃ­ dá»¥: `MODER_OFFSET` lÃ  alias cho offset cá»§a thanh ghi MODER (`0x00UL`).

---

