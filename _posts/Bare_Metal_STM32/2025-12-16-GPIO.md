---
title: "GPIO STM32"
date: 2025-12-16 09:19:34 +0800
categories: [Bare Metal STM32]
tags: [Bare Metal STM32]
---

# üìö STM32 GPIO Programming Guide

## üìå 1. Gi·ªõi thi·ªáu v·ªÅ GPIO

**GPIO (General Purpose Input/Output)** l√† c√°c ch√¢n v√†o/ra ƒëa nƒÉng tr√™n vi ƒëi·ªÅu khi·ªÉn STM32, cho ph√©p t∆∞∆°ng t√°c v·ªõi th·∫ø gi·ªõi b√™n ngo√†i.

### üó∫Ô∏è Memory Map

![Memory Map](/assets/Bare_Metal_STM32/GPIO/image_memory_map.png)

T·ª´ memory map c√≥ th·ªÉ th·∫•y **peripherals** n·∫±m t·ª´ v√πng nh·ªõ `0x40000000` ƒë·∫øn `0x5FFFFFFF`. 
- **Peripheral base address**: `0x40000000`
- ƒê∆∞·ª£c ph√¢n ra th√†nh nhi·ªÅu block: APB1, APB2, AHB1, AHB2, Cortex-M4 internal peripheral

> [!NOTE]
> **Advanced Peripheral Bus (APB)**: Giao ti·∫øp t·ªëc ƒë·ªô th·∫•p  
> **Advanced High-Performance Bus (AHB)**: Giao ti·∫øp t·ªëc ƒë·ªô cao

### ‚ú® 1.1 ƒê·∫∑c ƒëi·ªÉm c·ªßa GPIO STM32

- ‚öôÔ∏è C√≥ th·ªÉ c·∫•u h√¨nh l√† **input** ho·∫∑c **output**
- üîå H·ªó tr·ª£ **pull-up/pull-down**
- ‚ö° T·ªëc ƒë·ªô ƒë·∫ßu ra c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh
- üîÑ Ch·ª©c nƒÉng **alternate function**
- üéØ **Interrupt/Event handling**

### üèóÔ∏è 1.2 C·∫•u tr√∫c GPIO Port

**V√≠ d·ª•:** Trong b·∫£ng n√†y m√¨nh c·∫ßn t√¨m `GPIOA` th√¨ t√¨m ƒë·ªãa ch·ªâ c·ªßa n√≥ xem n√≥ ph·ª• thu·ªôc v√†o bus n√†o.

![GPIO Port Structure](/assets/Bare_Metal_STM32/GPIO/Boundary_addres.png)

·ªû ƒë√¢y ta th·∫•y **GPIOA** ƒëang ƒë∆∞·ª£c ph√¢n chia ƒë·ªãa ch·ªâ t·ª´ `0x4000 0000` ƒë·∫øn `0x4002 03FF`. 

```
Address = Peripheral Base Address + Offset
        = 0x40000000 + 0x20000
```

Ph·∫ßn `0x20000` ƒë∆∞·ª£c g·ªçi l√† **offset value**.

### ‚è∞ 1.3 Clock

> [!IMPORTANT]
> Clock cung c·∫•p pulse chung ƒë·ªÉ ƒë·ªìng b·ªô ho·∫°t ƒë·ªông c·ªßa microcontroller.  
> **Khi d√πng b·∫•t c·ª© peripheral n√†o ph·∫£i c·∫•p xung clock tr∆∞·ªõc!**

![GPIO Port Structure](/assets/Bare_Metal_STM32/GPIO/Boundary_addres.png)

Trong b·∫£ng n√†y **RCC (Reset and Clock Control)** n·∫±m t·ª´ address `0x4002 3800` ƒë·∫øn `0x4002 3BFF`.

### üìù 1.4 Quy t·∫Øc ƒë·∫∑t t√™n thanh ghi

C√°c thanh ghi trong STM32 tu√¢n th·ªß theo quy t·∫Øc:

```
PERIPHERAL_ACRONYM + UNDERSCORE + REGISTER_ACRONYM
```

**Peripheral acronym** - Vi·∫øt t·∫Øt t√™n c·ªßa ngo·∫°i vi:
- `GPIO` ‚Üí General Purpose Input/Output
- `USART` ‚Üí Universal Synchronous/Asynchronous Receiver Transmitter
- `TIM` ‚Üí Timer
- `ADC` ‚Üí Analog-to-Digital Converter

**Register acronym** - Vi·∫øt t·∫Øt c·ªßa thanh ghi:
- `CR` ‚Üí Control Register
- `SR` ‚Üí Status Register
- `DR` ‚Üí Data Register
- `BRR` ‚Üí Baud Rate Register

**V√≠ d·ª• k·∫øt h·ª£p:**
- `GPIOA_MODER` ‚Üí Register MODER c·ªßa peripheral GPIOA
- `USART1_SR` ‚Üí Status Register c·ªßa USART1
- `TIM2_CR1` ‚Üí Control Register 1 c·ªßa Timer 2

---

## üîß 2. Thao t√°c v·ªõi thanh ghi

### ‚úÖ Setting bit
S·ª≠ d·ª•ng to√°n t·ª≠ **OR**
```c
register |= (1 << position);
```

### ‚ùå Clear bit
S·ª≠ d·ª•ng to√°n t·ª≠ **AND**
```c
register &= ~(1 << position);
```

---

## ÔøΩ 3. C·∫•u h√¨nh GPIO Output

### üéØ 3.1 Enable Clock (AHB1ENR)

> [!TIP]
> ƒê·∫ßu ti√™n khi ƒëi·ªÅu khi·ªÉn GPIO th√¨ ph·∫£i c√≥ clock. T√¨m **RCC** ƒë·∫øn **AHB1ENR** ƒë·ªÉ c·∫•p clock cho bus AHB1.

```c
#define PERIPH_BASE         (0x40000000UL)  // 1: Define base address for peripherals
#define AHB1PERIPH_OFFSET   (0x00020000UL)  // 2: Offset for AHB1 peripheral bus
#define AHB1PERIPH_BASE     (PERIPH_BASE + AHB1PERIPH_OFFSET) // 3: Base address for AHB1 peripherals
```

### üîÑ 3.2 RCC (Reset and Clock Control)

```c
#define RCC_OFFSET          (0x00003800UL)                      // 6: Offset for RCC
#define RCC_BASE            (AHB1PERIPH_BASE + RCC_OFFSET)      // 7: Base address for RCC
```

### ‚öôÔ∏è 3.3 Mode Register (MODER)

```c
#define GPIOD_OFFSET        (0x00000C00UL)                      // 4: Offset for GPIOD
#define GPIOD_BASE          (AHB1PERIPH_BASE + GPIOD_OFFSET)    // 5: Base address for GPIOD
#define MODER_OFFSET        (0x00UL)                            // 10: Offset for mode register
#define GPIOD_MODER         (*(volatile unsigned int *)(GPIOD_BASE + MODER_OFFSET)) // 11: Address of GPIOD mode register
```

### üì§ 3.4 Data Output Register (ODR)

```c
#define ODR_OFFSET          (0x14UL)                            // 12: Offset for output data register
#define GPIO_ODR            (*(volatile unsigned int *)(GPIOD_BASE + ODR_OFFSET))   // 13: Address of GPIOD output data register
```

### üìç 3.5 Set Pin Output

```c
#define PIN_12              (1U << 12)  // 15: Bit mask for GPIOD pin 12
#define LED_1               PIN_12      // 16: Alias for PIN12 representing LED pin
```

---

## üöÄ 4. V√≠ d·ª• ho√†n ch·ªânh

### üí° 4.1 Blink LED tr√™n GPIOD Pin 12

```c
#include <stdint.h>

// üè† Base Addresses
#define PERIPH_BASE         (0x40000000UL)                      // 1: Define base address for peripherals
#define AHB1PERIPH_OFFSET   (0x00020000UL)                      // 2: Offset for AHB1 peripheral bus
#define AHB1PERIPH_BASE     (PERIPH_BASE + AHB1PERIPH_OFFSET)   // 3: Base address for AHB1 peripherals

// üìç GPIO Port D
#define GPIOD_OFFSET        (0x00000C00UL)                      // 4: Offset for GPIOD
#define GPIOD_BASE          (AHB1PERIPH_BASE + GPIOD_OFFSET)    // 5: Base address for GPIOD

// ‚è∞ RCC (Reset and Clock Control)
#define RCC_OFFSET          (0x00003800UL)                      // 6: Offset for RCC
#define RCC_BASE            (AHB1PERIPH_BASE + RCC_OFFSET)      // 7: Base address for RCC

// üìä Registers
#define AHB1EN_R_OFFSET     (0x30UL)                            // 8: Offset for AHB1EN register
#define RCC_AHB1EN_R        (*(volatile unsigned int *)(RCC_BASE + AHB1EN_R_OFFSET)) // 9: Address of AHB1EN Register

#define MODER_OFFSET        (0x00UL)                            // 10: Offset for mode register
#define GPIOD_MODER         (*(volatile unsigned int *)(GPIOD_BASE + MODER_OFFSET)) // 11: Address of GPIOD mode register

#define ODR_OFFSET          (0x14UL)                            // 12: Offset for output data register
#define GPIO_ODR            (*(volatile unsigned int *)(GPIOD_BASE + ODR_OFFSET))   // 13: Address of GPIOD output data register

// üéØ Pin Definitions
#define GPIOD_EN            (1U << 3)   // 14: Bit mask for enabling GPIOD (bit 3)
#define PIN_12              (1U << 12)  // 15: Bit mask for GPIOD pin 12
#define LED_1               PIN_12      // 16: Alias for PIN12 representing LED pin

int main(void)
{
    // ‚è∞ Enable clock for GPIOD
    RCC_AHB1EN_R |= GPIOD_EN;

    // ‚öôÔ∏è Configure Pin 12 as output (01)
    GPIOD_MODER &= ~(3U << (12 * 2));  // Clear bits 24-25
    GPIOD_MODER |=  (1U << (12 * 2));  // Set bit 24 to 1, bit 25 to 0

    // üí° Turn ON LED
    while (1)
    {
        GPIO_ODR |= LED_1;   // PD12 ON
    }
}
```

---

## üìñ 5. Gi·∫£i th√≠ch c√°c kh√°i ni·ªám quan tr·ªçng

### üî§ 5.1 H·∫≠u t·ªë `UL`

```c
#define PERIPH_BASE (0x40000000UL)
```

> [!NOTE]
> H·∫≠u t·ªë `UL` (Unsigned Long) cho ph√©p compiler hi·ªÉu r·∫±ng gi√° tr·ªã l√† m·ªôt s·ªë **kh√¥ng d·∫•u** (unsigned) v√† c√≥ k√≠ch th∆∞·ªõc **32 bit**.  
> N·∫øu kh√¥ng c√≥ `UL` th√¨ m·∫∑c ƒë·ªãnh l√† `Unsigned Int`.

### ‚ö†Ô∏è 5.2 T·ª´ kh√≥a `volatile`

```c
#define GPIOD_MODER (*(volatile unsigned int *)(GPIOD_BASE + MODER_OFFSET))
```

> [!IMPORTANT]
> T·ª´ kh√≥a `volatile` cho ph√©p compiler **kh√¥ng t·ªëi ∆∞u h√≥a** truy c·∫≠p v√†o thanh ghi.  
> 
> N·∫øu gi√° tr·ªã ƒë∆∞·ª£c ƒë·ªçc t·ª´ thanh ghi kh√¥ng thay ƒë·ªïi, compiler c√≥ th·ªÉ t·ªëi ∆∞u h√≥a code b·∫±ng c√°ch b·ªè qua c√°c truy c·∫≠p kh√¥ng c·∫ßn thi·∫øt v√† l·∫•y gi√° tr·ªã t·ª´ l·∫ßn truy c·∫≠p tr∆∞·ªõc ƒë√≥.  
> `volatile` ƒë·∫£m b·∫£o m·ªói l·∫ßn truy c·∫≠p ƒë·ªÅu ƒë·ªçc/ghi tr·ª±c ti·∫øp v√†o thanh ghi ph·∫ßn c·ª©ng.

### üé≠ 5.3 Bit Mask

```c
#define GPIOD_EN (1U << 3)  // Bit mask for enabling GPIOD
```

> [!TIP]
> **Bit mask** l√† m·ªôt binary number ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ thay ƒë·ªïi gi√° tr·ªã c·ªßa m·ªôt thanh ghi.  
> C√°c bitwise operations: **AND**, **OR**, **NOT**, **XOR**.

### üè∑Ô∏è 5.4 Alias

```c
#define LED_1 PIN_12  // Alias for PIN12 representing LED pin
```

> [!NOTE]
> **Alias** l√† m·ªôt t√™n kh√°c cho m·ªôt bit/group of bits ƒë·ªÉ d·ªÖ d√†ng ƒë·ªçc v√† d·ªÖ hi·ªÉu.  
> V√≠ d·ª•: `MODER_OFFSET` l√† alias cho offset c·ªßa thanh ghi MODER (`0x00UL`).

---

