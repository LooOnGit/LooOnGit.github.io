---
title: "I2C"
date: 2025-07-24 22:0:00 +0800
categories: [Protocol]
tags: [Protocol]
---

## 📡 Lý Thuyết I2C

### 🌟 Đặc Điểm Chính
- **Giao thức**: Truyền thông nối tiếp đồng bộ
- **Phát triển**: Philips Semiconductor (NXP), 1982
- **Ứng dụng**: Truyền thông khoảng cách ngắn
- **Tín hiệu**: SCL (Clock) và SDA (Data)
![alt text](/assets/Protocol/i2c_connect.png)

### 🚀 Ưu Điểm
- ✨ Thiết kế phần cứng đơn giản
- 🔗 Hỗ trợ nhiều thiết bị (multi-slave)
- 🔄 Truyền thông hai chiều
- ✅ Có cơ chế kiểm tra lỗi

### ⚡ Tốc Độ Truyền

| Chế độ | Tốc độ | Ứng dụng |
|:------:|:------:|:--------:|
| Standard | 100kHz | Thông thường |
| Fast | 400kHz | Tốc độ cao |
| Fast Plus | 1MHz | Hiệu năng cao |

### 🔄 Cấu Trúc Frame và Timing

#### 3.1 Cấu Trúc Frame Cơ Bản
![alt text](/assets/Protocol/i2c_dataframe.png)

![alt text](/assets/Protocol/i2c_dataframe2.png)

#### 3.2 Chi Tiết Từng Phần

1. **Điều Kiện START (S)**
   - **Trạng thái Idle**:
     - Ở trạng thái nghỉ, cả SDA và SCL đều ở mức HIGH
     - Bus đang ở trạng thái tự do, sẵn sàng cho truyền thông
   
   - **Quá trình tạo điều kiện START**:
     - Bước 1: Master kéo SDA xuống LOW (trong khi SCL vẫn HIGH)
     - Bước 2: Master kéo SCL xuống LOW
     - Quá trình này được gọi là "chiếm giữ bus" (claiming the bus)
   
   - **Ý nghĩa**:
     - Đánh dấu bắt đầu truyền thông
     - Node thực hiện điều kiện START trở thành Master
     - Ngăn chặn các node khác chiếm quyền điều khiển bus
     - Giảm thiểu nguy cơ xung đột trên bus
   
   - **Sau điều kiện START**:
     - Master có quyền điều khiển độc quyền bus
     - Master bắt đầu tạo xung clock trên đường SCL
     - Các node khác phải đợi đến khi có điều kiện STOP

2. **Địa Chỉ Slave (7 bit)**
   - **Yêu Cầu Cơ Bản**:
     - Mỗi thiết bị trên bus I2C phải có địa chỉ duy nhất
     - Địa chỉ được cố định và không thay đổi trong quá trình hoạt động
     - Truyền từ MSB (A6) đến LSB (A0)

   - **Định Dạng Địa Chỉ**:
     - Địa chỉ 7-bit là chuẩn phổ biến nhất: `A6 A5 A4 A3 A2 A1 A0`
     - Địa chỉ 10-bit cũng được hỗ trợ nhưng ít phổ biến hơn
     - Bit thứ 8 (R/W) được thêm vào sau địa chỉ để chỉ định hướng truyền.
     - Truyền từ MSB → LSB (MSB first bit)

   - **Số Lượng Thiết Bị Tối Đa**:
     - Địa chỉ 7-bit: 128 thiết bị (2^7)
     - Địa chỉ 10-bit: 1024 thiết bị (2^10)
     - Giới hạn thực tế thường do điện dung bus (400pF)

3. **Bit Read/Write (R/W)**
   - Bit thứ 8 sau địa chỉ
   - 0: Master → Slave (Write)
   - 1: Slave → Master (Read)

4. **Bit ACK/NACK**
   - Sau mỗi byte (8 bit)
   - Do bên nhận gửi (Receiver)
   - ACK = 0: Xác nhận đã nhận
   - NACK = 1: Không xác nhận/Kết thúc đọc

# Multiple data bytesS

![alt text](assets/Protocol/multi_i2c.png)

### 🕒 Mối Quan Hệ Timing giữa SDA và SCL

Để đảm bảo truyền thông I2C hoạt động chính xác, mối quan hệ timing giữa SDA và SCL cần tuân thủ các quy tắc sau:

1. **Quy Tắc Cơ Bản**:
   - SDA không được thay đổi khi SCL ở mức cao (HIGH)
   - SDA chỉ được phép thay đổi khi SCL ở mức thấp (LOW)
   - Ngoại lệ: điều kiện START và STOP

2. **Trong Quá Trình Truyền Dữ Liệu**:
    ![alt text](/assets/Protocol/timing_sda_scl.png)

   - SDA chỉ thay đổi khi SCL = LOW
   - SDA phải giữ ổn định khi SCL = HIGH
   - Dữ liệu được lấy mẫu tại cạnh lên của SCL

3. **Điều Kiện START/STOP**:
   ![alt text](/assets/Protocol/i2c_start_stop.png)
   - START: SDA chuyển từ HIGH → LOW khi SCL = HIGH
   - STOP: SDA chuyển từ LOW → HIGH khi SCL = HIGH

4. **Timing Diagram Chi Tiết**:
   ```
         Start         Data           Stop
         |            |              |
   SDA ‾‾‾\__________|‾‾‾‾‾‾\______/‾‾‾
            \         |       \    /
   SCL ‾‾‾‾‾‾\___/‾‾‾\___/‾‾‾\__/‾‾‾‾
   ```

### ⚡ Các Chế Độ Tốc Độ (Speed Modes)

I2C có thể hoạt động ở nhiều mức tốc độ khác nhau, được gọi là các "mode". Mỗi mode có đặc điểm và ứng dụng riêng.

#### 1. Các Mode Cơ Bản

| Chế Độ | Tốc Độ | Đặc Điểm |
|:-------|:-------|:---------|
| Standard Mode | 100 kbps | Mode chuẩn, phổ biến nhất |
| Fast Mode | 400 kbps | Tương thích ngược với Standard |
| Fast Mode Plus | 1 Mbps | Cần điện trở pull-up thích hợp |

#### 2. Các Mode Tốc Độ Cao

| Chế Độ | Tốc Độ | Đặc Điểm Đặc Biệt |
|:-------|:-------|:------------------|
| High Speed Mode | 3.4 Mbps | - Tương thích ngược với mode chậm hơn<br>- Cần chuỗi khởi tạo đặc biệt để chuyển sang HS<br>- Điện trở pull-up riêng cho HS |
| Ultra Fast Mode | 5 Mbps | - Chỉ hỗ trợ truyền một chiều (write-only)<br>- Yêu cầu sửa đổi giao thức và frame<br>- Không tương thích với các mode khác |

### "Open drain"
 - Ngõ ra "open-drain" chỉ gồm một transistor MOSFET có chân drain (D) nối ra ngoài, chân source (S) nối GND. Khi transistor ON, nó kéo tín hiệu xuống GND. Khi transistor OFF, ngõ ra trở thành trạng thái "hở mạch" (không nối gì), nên để có mức HIGH, ta cần một điện trở kéo lên (pull-up) đến nguồn (Vcc).

 ### CMOS
 - CMOS là viết tắt của Complementary Metal-Oxide-Semiconductor – tức là Bán dẫn Oxide kim loại bù. Đây là một công nghệ chế tạo vi mạch phổ biến, đặc biệt trong:

**CMOS sử dụng hai loại transistor MOSFET:**
- NMOS (n-type MOSFET)
- PMOS (p-type MOSFET)