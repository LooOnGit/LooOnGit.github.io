---
title: "CAN BUS"
date: 2025-07-29 19:09:00 +0800
categories: [Protocol]
tags: [Protocol]
---

# CAN
## Giới thiệu
CAN là một chuẩn giao tiếp có dây được phát triển bởi công ty BOSCH. CAN được thiết kế để cho phép liên lạc hiệu quả và đơn giản giữa các bộ điều khiển điện tử (ECU – Electronic Control Unit – Node) trong một mạng phức tạp.

### ECU
Mỗi chức năng của xe hơi sẽ do một bộ điều khiển đảm nhận được gọi là ECU (Electronic Control Unit) hay ECM (Electronic Control Module). Đây là một hệ thống nhúng trong hệ thống điện tử của ô tô. 
Trong một số xe hiện đại, số lượng ECU có thể lên tới 150 đơn vị. Các ECU này liên tục được phát triển: tăng về số lượng, độ phức tạp và độ tinh vi. Vì vậy việc quản lý hiệu quả một hệ thống phức tạp, nhiều thành phần mà vẫn phải đáp ứng nhiều điều kiện khắt khe trong tiêu chuẩn ngành công nghiệp xe hơi thật sự là thử thách lớn với các nhà sản xuất và phát triển.
![alt text](/assets/Protocol/oto_components.png)

### CAN – Đơn giản hóa sự phức tạp
BOSCH tạo ra giao thức CAN nhằm đơn giản hóa việc giao tiếp giữa các ECU từ đó tăng khả năng kiểm soát và tối ưu hóa những hệ thống điện bao gồm nhiều thành phần có những chức năng khác nhau. Có thể hiểu, CAN có thể được áp dụng hiệu quả nhất trong các hệ thống cấu tạo từ nhiều vi điều khiển, cần giao tiếp với nhau một cách ổn định, tin cậy.
**Ưu điểm:**
- Chỉ có 2 dây, dễ lắp đặt.
- Canbus được thiết kế tăng khả năng chống nhiễu khi hoạt động trong môi trường không ổn định như xe hơi.

## Cấu tạo
Trong một ECU trên CanBus có 3 thành phần: MCU, Can Controller và Can Transceiver.
- **Vi điều khiển**: Xử lý dữ liệu nhận dudocj từ Can Controller và truyển dũ liệu đến các ECU.
- **Can Controller**: Một số MCU sẽ được tích hợp như STM32. Khi truyền dữ liệu từ MCU truyền vào khi bus rảnh. Khi nhận lưu trữ các bit nhận được từ bus cho đến khi có toàn bộ khung truyền (nhờ EOF) và thông báo MCU lấy lại tin đó.
- **Can transceiver**: Khi nhận chuyển đổi mức điện áp trên bus CAN thành mức mà CAN controller có thể hiểu được (bit nhị phân).
Khi truyền nó chuyển đổi luồng dữ liệu logic nhị phân từ CAN controller thành mức logic của bus CAN.
![alt text](/assets/Protocol/can_connect.png)

## Cơ chế truyền nhận trên dây
Sử dụng 2 dây để giao tiếp được gọi là CAN High và CAN Low. Không phân biệt master và slave.
Các điểm đầu và cuối can bus có trở 120ohm, điện trở nay dudocj gọi là terminator resistor.
![alt text](/assets/Protocol/Can_120ohm.png)
**Tại sao lại 120ohm mà không phải giá trị nào khác?**
Vì trở kháng đặc trưng của cáp xoắn đôi trong hệ thông CAN là khoảng 120ohm, nên cần dùng trở để kết thúc có giá trị bằng với trở kháng để tránh phản xạ tín hiệu. Phản xạ tín hiệu là kiểu bạn hét vào 1 cái hang thì sẽ nghe tiếng vọng lại thì tín hiệu cũng vậy gặp điểm cuối không hấp thụ đúng cách sẽ phản xạ ngược lại và gây nhiễu.

CAN sử dụng mức điện chênh lệch điện áp giữa 2 dây để quy đổi. Những thay đổi về mức điện áp này sai đó dịch sang mức logic:
![alt text](/assets/Protocol/can_signal.png)
Thông thường, giá trị điện áp cao nhất ở dây CAN High là 3.5V, điện áp thấp nhất là 2.5V.  Ở dây CAN low điện áp thấp nhất là 1.5V và cao nhất là 2.5V:
- **Mức logic 0**: Khi VCANH – VCANL = 2.5V. Hay mức chênh lệch điện áp 2 dây là 2.5V.
- **Mức logic 1**: Khi VCANH – VCANL = 0V. Hay khi cả hai dây đều có điện áp 2.5V.

## Data frame
![alt text](/assets/Protocol/Can_Data_frame.png)

## Remote frame
![alt text](/assets/Protocol/Can_remote_frame.png)

## Error frame
![alt text](/assets/Protocol/Can_error_frame.png)