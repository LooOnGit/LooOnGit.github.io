---
title: "CAN BUS"
date: 2025-07-29 19:09:00 +0800
categories: [Protocol]
tags: [Protocol]
---

# CAN
## Giá»›i thiá»‡u
CAN lÃ  má»™t chuáº©n giao tiáº¿p cÃ³ dÃ¢y Ä‘Æ°á»£c phÃ¡t triá»ƒn bá»Ÿi cÃ´ng ty BOSCH. CAN Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ cho phÃ©p liÃªn láº¡c hiá»‡u quáº£ vÃ  Ä‘Æ¡n giáº£n giá»¯a cÃ¡c bá»™ Ä‘iá»u khiá»ƒn Ä‘iá»‡n tá»­ (ECU â€“ Electronic Control Unit â€“ Node) trong má»™t máº¡ng phá»©c táº¡p.

### ECU
Má»—i chá»©c nÄƒng cá»§a xe hÆ¡i sáº½ do má»™t bá»™ Ä‘iá»u khiá»ƒn Ä‘áº£m nháº­n Ä‘Æ°á»£c gá»i lÃ  ECU (Electronic Control Unit) hay ECM (Electronic Control Module). ÄÃ¢y lÃ  má»™t há»‡ thá»‘ng nhÃºng trong há»‡ thá»‘ng Ä‘iá»‡n tá»­ cá»§a Ã´ tÃ´. 
Trong má»™t sá»‘ xe hiá»‡n Ä‘áº¡i, sá»‘ lÆ°á»£ng ECU cÃ³ thá»ƒ lÃªn tá»›i 150 Ä‘Æ¡n vá»‹. CÃ¡c ECU nÃ y liÃªn tá»¥c Ä‘Æ°á»£c phÃ¡t triá»ƒn: tÄƒng vá» sá»‘ lÆ°á»£ng, Ä‘á»™ phá»©c táº¡p vÃ  Ä‘á»™ tinh vi. VÃ¬ váº­y viá»‡c quáº£n lÃ½ hiá»‡u quáº£ má»™t há»‡ thá»‘ng phá»©c táº¡p, nhiá»u thÃ nh pháº§n mÃ  váº«n pháº£i Ä‘Ã¡p á»©ng nhiá»u Ä‘iá»u kiá»‡n kháº¯t khe trong tiÃªu chuáº©n ngÃ nh cÃ´ng nghiá»‡p xe hÆ¡i tháº­t sá»± lÃ  thá»­ thÃ¡ch lá»›n vá»›i cÃ¡c nhÃ  sáº£n xuáº¥t vÃ  phÃ¡t triá»ƒn.
![alt text](/assets/Protocol/oto_components.png)

### CAN â€“ ÄÆ¡n giáº£n hÃ³a sá»± phá»©c táº¡p
BOSCH táº¡o ra giao thá»©c CAN nháº±m Ä‘Æ¡n giáº£n hÃ³a viá»‡c giao tiáº¿p giá»¯a cÃ¡c ECU tá»« Ä‘Ã³ tÄƒng kháº£ nÄƒng kiá»ƒm soÃ¡t vÃ  tá»‘i Æ°u hÃ³a nhá»¯ng há»‡ thá»‘ng Ä‘iá»‡n bao gá»“m nhiá»u thÃ nh pháº§n cÃ³ nhá»¯ng chá»©c nÄƒng khÃ¡c nhau. CÃ³ thá»ƒ hiá»ƒu, CAN cÃ³ thá»ƒ Ä‘Æ°á»£c Ã¡p dá»¥ng hiá»‡u quáº£ nháº¥t trong cÃ¡c há»‡ thá»‘ng cáº¥u táº¡o tá»« nhiá»u vi Ä‘iá»u khiá»ƒn, cáº§n giao tiáº¿p vá»›i nhau má»™t cÃ¡ch á»•n Ä‘á»‹nh, tin cáº­y.
**Æ¯u Ä‘iá»ƒm:**
- Chá»‰ cÃ³ 2 dÃ¢y, dá»… láº¯p Ä‘áº·t.
- Canbus Ä‘Æ°á»£c thiáº¿t káº¿ tÄƒng kháº£ nÄƒng chá»‘ng nhiá»…u khi hoáº¡t Ä‘á»™ng trong mÃ´i trÆ°á»ng khÃ´ng á»•n Ä‘á»‹nh nhÆ° xe hÆ¡i.

## Cáº¥u táº¡o
Trong má»™t ECU trÃªn CanBus cÃ³ 3 thÃ nh pháº§n: MCU, Can Controller vÃ  Can Transceiver.
- **Vi Ä‘iá»u khiá»ƒn**: Xá»­ lÃ½ dá»¯ liá»‡u nháº­n dudocj tá»« Can Controller vÃ  truyá»ƒn dÅ© liá»‡u Ä‘áº¿n cÃ¡c ECU.
- **Can Controller**: Má»™t sá»‘ MCU sáº½ Ä‘Æ°á»£c tÃ­ch há»£p nhÆ° STM32. Khi truyá»n dá»¯ liá»‡u tá»« MCU truyá»n vÃ o khi bus ráº£nh. Khi nháº­n lÆ°u trá»¯ cÃ¡c bit nháº­n Ä‘Æ°á»£c tá»« bus cho Ä‘áº¿n khi cÃ³ toÃ n bá»™ khung truyá»n (nhá» EOF) vÃ  thÃ´ng bÃ¡o MCU láº¥y láº¡i tin Ä‘Ã³.
- **Can transceiver**: Khi nháº­n chuyá»ƒn Ä‘á»•i má»©c Ä‘iá»‡n Ã¡p trÃªn bus CAN thÃ nh má»©c mÃ  CAN controller cÃ³ thá»ƒ hiá»ƒu Ä‘Æ°á»£c (bit nhá»‹ phÃ¢n).
Khi truyá»n nÃ³ chuyá»ƒn Ä‘á»•i luá»“ng dá»¯ liá»‡u logic nhá»‹ phÃ¢n tá»« CAN controller thÃ nh má»©c logic cá»§a bus CAN.
![alt text](/assets/Protocol/can_connect.png)

## CÆ¡ cháº¿ truyá»n nháº­n trÃªn dÃ¢y
Sá»­ dá»¥ng 2 dÃ¢y Ä‘á»ƒ giao tiáº¿p Ä‘Æ°á»£c gá»i lÃ  CAN High vÃ  CAN Low. KhÃ´ng phÃ¢n biá»‡t master vÃ  slave.
CÃ¡c Ä‘iá»ƒm Ä‘áº§u vÃ  cuá»‘i can bus cÃ³ trá»Ÿ 120ohm, Ä‘iá»‡n trá»Ÿ nay dudocj gá»i lÃ  terminator resistor.
![alt text](/assets/Protocol/Can_120ohm.png)
**Táº¡i sao láº¡i 120ohm mÃ  khÃ´ng pháº£i giÃ¡ trá»‹ nÃ o khÃ¡c?**
VÃ¬ trá»Ÿ khÃ¡ng Ä‘áº·c trÆ°ng cá»§a cÃ¡p xoáº¯n Ä‘Ã´i trong há»‡ thÃ´ng CAN lÃ  khoáº£ng 120ohm, nÃªn cáº§n dÃ¹ng trá»Ÿ Ä‘á»ƒ káº¿t thÃºc cÃ³ giÃ¡ trá»‹ báº±ng vá»›i trá»Ÿ khÃ¡ng Ä‘á»ƒ trÃ¡nh pháº£n xáº¡ tÃ­n hiá»‡u. Pháº£n xáº¡ tÃ­n hiá»‡u lÃ  kiá»ƒu báº¡n hÃ©t vÃ o 1 cÃ¡i hang thÃ¬ sáº½ nghe tiáº¿ng vá»ng láº¡i thÃ¬ tÃ­n hiá»‡u cÅ©ng váº­y gáº·p Ä‘iá»ƒm cuá»‘i khÃ´ng háº¥p thá»¥ Ä‘Ãºng cÃ¡ch sáº½ pháº£n xáº¡ ngÆ°á»£c láº¡i vÃ  gÃ¢y nhiá»…u.

CAN sá»­ dá»¥ng má»©c Ä‘iá»‡n chÃªnh lá»‡ch Ä‘iá»‡n Ã¡p giá»¯a 2 dÃ¢y Ä‘á»ƒ quy Ä‘á»•i. Nhá»¯ng thay Ä‘á»•i vá» má»©c Ä‘iá»‡n Ã¡p nÃ y sai Ä‘Ã³ dá»‹ch sang má»©c logic:
![alt text](/assets/Protocol/can_signal.png)
ThÃ´ng thÆ°á»ng, giÃ¡ trá»‹ Ä‘iá»‡n Ã¡p cao nháº¥t á»Ÿ dÃ¢y CAN High lÃ  3.5V, Ä‘iá»‡n Ã¡p tháº¥p nháº¥t lÃ  2.5V.  á» dÃ¢y CAN low Ä‘iá»‡n Ã¡p tháº¥p nháº¥t lÃ  1.5V vÃ  cao nháº¥t lÃ  2.5V:
- **Má»©c logic 0**: Khi VCANH â€“ VCANL = 2.5V. Hay má»©c chÃªnh lá»‡ch Ä‘iá»‡n Ã¡p 2 dÃ¢y lÃ  2.5V.
- **Má»©c logic 1**: Khi VCANH â€“ VCANL = 0V. Hay khi cáº£ hai dÃ¢y Ä‘á»u cÃ³ Ä‘iá»‡n Ã¡p 2.5V.
Äiá»u Ä‘Ã³ cho tháº¥y rÄƒng kháº£ nÄƒng khÃ¡ng nhiá»…u ráº¥t tá»‘t, khi cÃ³ nhiá»…u thÃ¬ má»©c Ã¡p trÃªn 2 dÃ¢y cÃ¹ng thay Ä‘á»•i nhÆ°ng chÃªnh lá»‡ch Ä‘iá»‡n Ã¡p 2 dÃ¢y khÃ´ng thay Ä‘á»•i nhiá»u.
![alt text](/assets/Protocol/can_signal2.png)

## CÆ¡ truyá»n gÃ³i tin
Má»—i ECU trÃªn bus cÃ³ má»™t ID Ä‘á»‹nh danh phÃ¢n biá»‡t vá»›i cÃ¡c ECU khÃ¡c.
Táº¥t cáº£ cÃ¡c ECU trÃªn bus Ä‘á»u Ä‘Æ°á»£c ná»‘i song song vá»›i Ä‘Æ°á»ng dÃ¢y, Ä‘iá»u nÃ y dáº«n Ä‘áº¿n táº¥t cáº£ cÃ¡c ECU Ä‘á»u nháº­n má»i dá»¯ liá»‡u cháº¡y trÃªn Ä‘Æ°á»ng bus má»i lÃºc. ChÃºng ta cÃ³ thá»ƒ cáº¥u hÃ¬nh Ä‘á»ƒ 1 ECU chá»‰ nháº­n gÃ³i tin Ä‘áº¿n tá»« má»™t hay nhiá»u ECU nháº¥t Ä‘á»‹nh báº±ng ID.
CÃ³ 4 loáº¡i gÃ³i tin CAN : Data Frame, Remote Frame, Error Frame and Overload Frame.

### Data frame
GÃ³i tin Ä‘Æ°á»£c truyá»n tá»« ECU nÃ y sang ECU khÃ¡c.
![alt text](/assets/Protocol/Can_Data_frame.png)
**SOF**: bit nÃ y xuá»‘ng 0 Ä‘á»ƒ thÃ´ng bÃ¡o cÃ³ ECU muá»‘n truyá»n dá»¯ liá»‡u.
**Identifier**: 

### Remote frame
Cung cáº¥p kháº£ nÄƒng cho phÃ©p ECU yÃªu cáº§u thÃ´ng tin tá»« cÃ¡c ECU khÃ¡c.
![alt text](/assets/Protocol/Can_remote_frame.png)

### Error frame
![alt text](/assets/Protocol/Can_error_frame.png)

## Tham kháº£o

- [CAN Protocol - MBedded Ninja](https://blog.mbedded.ninja/electronics/communication-protocols/can-protocol/)
- [Vector - CAN Standard Data Frame Video](https://www.vector.com/int/en/know-how/can/can-knowledge/can-data-frame/)
- ğŸ“º [CAN Bus Explained â€“ YouTube Video](https://www.youtube.com/watch?v=2Mhqwt2xTxk)  