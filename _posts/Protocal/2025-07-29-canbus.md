---
title: "CAN"
date: 2025-07-29 19:09:00 +0800
categories: [Protocol]
tags: [Protocol]
---

# CAN
## Giới thiệu
CAN là một chuẩn giao tiếp có dây được phát triển bởi công ty BOSCH. CAN được thiết kế để cho phép liên lạc hiệu quả và đơn giản giữa các bộ điều khiển điện tử (ECU – Electronic Control Unit – Node) trong một mạng phức tạp.

### ECU
Mỗi chức năng của xe hơi sẽ do một bộ điều khiển đảm nhận được gọi là ECU (Electronic Control Unit) hay ECM (Electronic Control Module). Đây là một hệ thống nhúng trong hệ thống điện tử của ô tô. 
Trong một số xe hiện đại, số lượng ECU có thể lên tới 150 đơn vị. Các ECU này liên tục được phát triển: tăng về số lượng, độ phức tạp và độ tinh vi. Vì vậy việc quản lý hiệu quả một hệ thống phức tạp, nhiều thành phần mà vẫn phải đáp ứng nhiều điều kiện khắt khe trong tiêu chuẩn ngành công nghiệp xe hơi thật sự là thử thách lớn với các nhà sản xuất và phát triển.
![alt text](/assets/Protocol/oto_components.png)

### CAN – Đơn giản hóa sự phức tạp
BOSCH tạo ra giao thức CAN nhằm đơn giản hóa việc giao tiếp giữa các ECU từ đó tăng khả năng kiểm soát và tối ưu hóa những hệ thống điện bao gồm nhiều thành phần có những chức năng khác nhau. Có thể hiểu, CAN có thể được áp dụng hiệu quả nhất trong các hệ thống cấu tạo từ nhiều vi điều khiển, cần giao tiếp với nhau một cách ổn định, tin cậy.
**Ưu điểm:**
- Chỉ có 2 dây, dễ lắp đặt.
- Canbus được thiết kế tăng khả năng chống nhiễu khi hoạt động trong môi trường không ổn định như xe hơi.

## Cấu tạo
Trong một ECU trên CanBus có 3 thành phần: MCU, Can Controller và Can Transceiver.
- **Vi điều khiển**: Xử lý dữ liệu nhận dudocj từ Can Controller và truyển dũ liệu đến các ECU.
- **Can Controller**: Một số MCU sẽ được tích hợp như STM32. Khi truyền dữ liệu từ MCU truyền vào khi bus rảnh. Khi nhận lưu trữ các bit nhận được từ bus cho đến khi có toàn bộ khung truyền (nhờ EOF) và thông báo MCU lấy lại tin đó.
- **Can transceiver**: Khi nhận chuyển đổi mức điện áp trên bus CAN thành mức mà CAN controller có thể hiểu được (bit nhị phân).
Khi truyền nó chuyển đổi luồng dữ liệu logic nhị phân từ CAN controller thành mức logic của bus CAN.
![alt text](/assets/Protocol/can_connect.png)

## Cơ chế truyền nhận trên dây
Sử dụng 2 dây để giao tiếp được gọi là CAN High và CAN Low. Không phân biệt master và slave.
Các điểm đầu và cuối can bus có trở 120ohm, điện trở nay dudocj gọi là terminator resistor.
![alt text](/assets/Protocol/Can_120ohm.png)
**Tại sao lại 120ohm mà không phải giá trị nào khác?**
Vì trở kháng đặc trưng của cáp xoắn đôi trong hệ thông CAN là khoảng 120ohm, nên cần dùng trở để kết thúc có giá trị bằng với trở kháng để tránh phản xạ tín hiệu. Phản xạ tín hiệu là kiểu bạn hét vào 1 cái hang thì sẽ nghe tiếng vọng lại thì tín hiệu cũng vậy gặp điểm cuối không hấp thụ đúng cách sẽ phản xạ ngược lại và gây nhiễu.

CAN sử dụng mức điện chênh lệch điện áp giữa 2 dây để quy đổi. Những thay đổi về mức điện áp này sai đó dịch sang mức logic:
![alt text](/assets/Protocol/can_signal.png)
Thông thường, giá trị điện áp cao nhất ở dây CAN High là 3.75V, điện áp thấp nhất là 2.5V.  Ở dây CAN low điện áp thấp nhất là 1.25 V và cao nhất là 2.5V:
- **Mức logic 0**: Khi VCANH – VCANL = 2.5V. Hay mức chênh lệch điện áp 2 dây là 2.5V.
- **Mức logic 1**: Khi VCANH – VCANL = 0V. Hay khi cả hai dây đều có điện áp 2.5V.
Điều đó cho thấy răng khả năng kháng nhiễu rất tốt, khi có nhiễu thì mức áp trên 2 dây cùng thay đổi nhưng chênh lệch điện áp 2 dây không thay đổi nhiều.
![alt text](/assets/Protocol/can_signal2.png)

## Cơ truyền gói tin
Mỗi ECU trên bus có một ID định danh phân biệt với các ECU khác.
Tất cả các ECU trên bus đều được nối song song với đường dây, điều này dẫn đến tất cả các ECU đều nhận mọi dữ liệu chạy trên đường bus mọi lúc. Chúng ta có thể cấu hình để 1 ECU chỉ nhận gói tin đến từ một hay nhiều ECU nhất định bằng ID.
Có 4 loại gói tin CAN : Data Frame, Remote Frame, Error Frame and Overload Frame.
Có 2 loại CAN là Standard CAN (11 bit identifiers) và Extended CAN (29 bit identifiers)
### Data frame
Gói tin được truyền từ ECU này sang ECU khác.
![alt text](/assets/Protocol/Can_Data_frame.png)

### Remote frame
Cung cấp khả năng cho phép ECU yêu cầu thông tin từ các ECU khác.
![alt text](/assets/Protocol/Can_remote_frame.png)

### Error frame
![alt text](/assets/Protocol/Can_error_frame.png)
**SOF**: dominant bit này xuống 0 để thông báo có ECU muốn truyền dữ liệu.

Trường **Arbitration (Trọng tài)** bao gồm ID và RTR
- **Identifier**: ID là định danh của một ECU, được sử dụng để chỉ rõ ECU nào đang gửi gói tin. ID càng thấp độ ưu tiên càng cao, gồm 11 bit cho gói standard và 29 bit gói extended. Dùng định danh gói tin và phân quyền không phải địa chỉ như I2C.

**VD:** CAN Controller trong MCU có các bộ lọc ID. Bạn lập trình để chỉ nhận những gói tin có ID mà node quan tâm. Những gói không phù hợp sẽ bị bỏ qua ở mức phần cứng → tiết kiệm CPU.
- Node 1 chỉ quan tâm đến ID 0x100, 0x101
- Node 2 chỉ quan tâm đến ID 0x200
- Khi nhận được gói 0x100, chỉ Node 1 nhận và xử lý.
- **RTR**: 1 bit dùng thiết lập gói tin là Data Frame hay Remote Frame. Nếu gói tin gửi đi là Remote Frame thì không cần Data Field. Nếu nó là một **dominant** (0) bit thì nó là data frame, còn nếu nó là 1 **recessive** (1) bit thì nó là remote frame.

Trường **Control**:
- **IDE** (Identifier Extension): 1 bit dùng để kiểm tra xem gói tin Extended hay Standard. Nếu IDE là dominant (0) thì nó là standard frame (11 bit identifier) và nếu nó là recessive (1) thì nó là extended frame (29 bit identifier).
- **r0**: như là một bit dự phòng (reserved bit).
- **DLC** (Data Length Code): 4bit, xác định độ dài dữ liệu truyền 0 - 8 bytes.

Trường **Data**: chứa 8 bytes dữ liệu truyền đi. Khi truyền sẽ truyền MSB(Most Significant Bit) trước.

Trường **CRC** (Cyclic Redundancy Check):
- **CRC sequence**: độ dài 15 bit.
- **CRC Delimiter**: 1 bit phải là recessive bit (1).

Trường **ACK**: 2bit
- **ACK**: bit này cho biết liệu ECU có nhận dudocj dữ liệu chưa. Bên gửi sẽ gửi recessive bit và khi bên nhận nhận được sẽ ghi đè lên nó là dominant bit.
- **ACK Delimiter**: phân cách ack và thường là recessive bit.

**EOF** (End Of Frame): Đánh dấu kết thúc khung.Nó có độ dài là 7 bit recessive (1111111).



## Tham khảo

- [CAN Protocol - MBedded Ninja](https://blog.mbedded.ninja/electronics/communication-protocols/can-protocol/)
- [Vector - CAN Standard Data Frame Video](https://www.vector.com/int/en/know-how/can/can-knowledge/can-data-frame/)
- 📺 [CAN Bus Explained – YouTube Video](https://www.youtube.com/watch?v=2Mhqwt2xTxk)  
- [Difference between Standard CAN and Extended CAN frame explained](https://automotivevehicletesting.com/standard-can-and-extended-can-frame/)