---
title: "Makefile"
date: 2025-07-26 21:26:00 +0800
categories: [Makefile]
tags: [Makefile]
---

# Makefile

## Tại sao lại có makefile?
![alt text](/assets/makefile/makefile.png)
Trong một chương trình lón, nhiều driver nhưng khi build thì phải theo trình tự build process như hình bên dưới. Dẫn đến trường hợp khi build số lượng file lớn thì gõ đi gõ lại nhiều lần nên makefile sinh ra để giải quyết điều này.
![alt text](/assets/makefile/build_process.png)

### running the example
```makefile
hello:
	echo "Tran Cong Hoa"
```
result:
![alt text](/assets/makefile/make_example1.png)

### Cu phap Makefile
- Makefile bao gồm tập hợp các rule (quy tắc). Mỗi rule thường có dạng:
```makefile
targets: prerequisites
	command
	command
	command
```
- **Targets** là tên của các tệp tin, được phân tách bằng dấu cách.
- **Command** là một chuỗi các bước được dùng để tạo ra target.
- **Prerequisites** là tên các tệp tin, được phân tách bằng dấu cách. Các tệp này cần tồn tại trước khi các lệnh được thực thi để tạo ra mục tiêu. Chúng còn được gọi là dependencies (các phụ thuộc).

### Ban chat cua makefile
```makefile
hello:
	echo "Hello, World"
	echo "This line will print if the file hello does not exist."
```
- Ở đây có mục tiêu (target) là hello
- Mục tiêu có 2 lệnh (command).
- Mục tiêu không có phần phụ thuộc (dependencies).

#### VD2:
- Toi co file ".c"
```c
#include <stdio.h>

int main(){
    printf("Hello, World!\n");
    return 0;
}
```
trong makefile
```makefile
hello:
	gcc main.c -o hello
```

Khi chạy lệnh make, vì không có target nào được cung cấp, nên target đầu tiên (hello) sẽ được thực thi. Lần đầu chạy, Make sẽ chạy các lệnh và tạo ra file hello.

Tuy nhiên, lần thứ hai chạy, Make sẽ thấy file hello đã tồn tại, nên sẽ không thực thi lại và hiện thông báo:
```makefile
make: 'hello' is up to date.
```

Vấn đề ở đây là: nếu có một file **.c** nào đó bị sửa đổi (chẳng hạn hello.c), thì khi chạy make cũng không tái biên dịch, vì Make không biết rằng file **.c** đó là một dependencies của hello.
```makefile
hello: main.c
	gcc main.c -o hello
```
Khi chạy thì nó chỉ chạy nếu như hello chưa tồn tại hoặc đã tồn tại nhưng main.c có sự thay đổi khác với hello đã biên dịch trước đó.

Hiểu rõ điều này có thể được giải thích, Make sử dụng timestamp của hệ thống tập tin để xác định xem có thứ gì bị thay đổi không. Vì timestamp của tập tin thường chỉ thay đổi khi tập tin bị chỉnh sửa.

Điều này cũng không hẳn đúng vì có thể chỉnh sửa timestamp thành thời gian cũ hơn thì Make sẽ hiểu không có gì thay đổi mới hơn.

### Make clean
clean thì thường được sử dụng để xóa các file output của những target khác. Có thể chạy make và make clean để tạo và xóa toàn bộ file.

clean sẽ không bao giờ được thực thi trừ khi gọi make clean.

```make file
files: 
	touch some_files

clean:
	rm -f some_files
```

### Variables
Bien chi la strings. Thuong su dung :=, =.
#### VD5:

```makefile
files := file1 file2
some_file: $(files)
	echo "Look at this variable: " $(files)
	touch some_file

file1:
	touch file1
file2:
	touch file2

clean:
	rm -f file1 file2 some_file
```
Đơn hoặc đôi thì không có ý nghĩa trong Make. Chúng chỉ là các ký tự gán cho biến.

```makefile
a := one two# a is set to the string "one two"
b := 'one two' # Not recommended. b is set to the string "'one two'"
all:
	printf '$a'
	printf $b
```
Các biến tham chiếu bằng **${}** hoặc **$()** có dấu.

```makefile
x := dude

all:
	echo $(x)
	echo ${x}

	# Bad practice, but works
	echo $x 
```
