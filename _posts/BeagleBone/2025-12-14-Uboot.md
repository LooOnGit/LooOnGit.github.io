---
title: "U-Boot - Universal Bootloader"
date: 2025-12-14 11:00:12 +0700
categories: [BeagleBone]
tags: [BeagleBone, U-Boot, Bootloader, Embedded Linux]
---

## ğŸš€ Tá»•ng quan vá» U-Boot

**U-Boot** (Universal Bootloader) lÃ  má»™t bootloader mÃ£ nguá»“n má»Ÿ phá»• biáº¿n Ä‘Æ°á»£c sá»­ dá»¥ng rá»™ng rÃ£i trong cÃ¡c há»‡ thá»‘ng nhÃºng. U-Boot chá»‹u trÃ¡ch nhiá»‡m khá»Ÿi táº¡o pháº§n cá»©ng vÃ  náº¡p há»‡ Ä‘iá»u hÃ nh Linux kernel vÃ o bá»™ nhá»›.

### ğŸ“Œ Táº¡i sao cáº§n U-Boot?

- ğŸ”§ **Khá»Ÿi táº¡o pháº§n cá»©ng**: Thiáº¿t láº­p RAM, clock, peripherals
- ğŸ’¾ **Náº¡p kernel**: Load Linux kernel tá»« flash/SD card vÃ o RAM
- âš™ï¸ **Cáº¥u hÃ¬nh linh hoáº¡t**: Cho phÃ©p thay Ä‘á»•i tham sá»‘ boot
- ğŸ› ï¸ **Debug vÃ  recovery**: MÃ´i trÆ°á»ng Ä‘á»ƒ sá»­a lá»—i há»‡ thá»‘ng

---

## ğŸ—ï¸ Kiáº¿n trÃºc U-Boot

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Power On / Reset            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ROM Boot Loader (SPL)          â”‚
â”‚  â€¢ Khá»Ÿi táº¡o cÆ¡ báº£n                  â”‚
â”‚  â€¢ Load U-Boot vÃ o RAM              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         U-Boot Main Stage           â”‚
â”‚  â€¢ Khá»Ÿi táº¡o Ä‘áº§y Ä‘á»§ pháº§n cá»©ng        â”‚
â”‚  â€¢ Thiáº¿t láº­p mÃ´i trÆ°á»ng             â”‚
â”‚  â€¢ Command line interface           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Load & Boot Kernel           â”‚
â”‚  â€¢ Load kernel image                â”‚
â”‚  â€¢ Load device tree                 â”‚
â”‚  â€¢ Boot vÃ o Linux                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

![image](/assets/BeagleBone/Uboot/image.png)

![image](/assets/BeagleBone/Uboot/image2.png)

TrÃªn SOC má»—i module cháº¡y bá»™ xung khÃ¡c nhau cÅ©ng giá»‘ng MCU.
---

## ğŸ“¦ Cáº¥u trÃºc thÆ° má»¥c U-Boot

```
u-boot/
â”œâ”€â”€ ğŸ“ arch/           # Kiáº¿n trÃºc CPU (ARM, x86, MIPS...)
â”œâ”€â”€ ğŸ“ board/          # Board-specific code
â”œâ”€â”€ ğŸ“ cmd/            # U-Boot commands
â”œâ”€â”€ ğŸ“ common/         # Common code
â”œâ”€â”€ ğŸ“ configs/        # Defconfig files
â”œâ”€â”€ ğŸ“ drivers/        # Device drivers
â”œâ”€â”€ ğŸ“ include/        # Header files
â”œâ”€â”€ ğŸ“ net/            # Networking
â””â”€â”€ ğŸ“ tools/          # Build tools
```

---

## ğŸ”¨ BiÃªn dá»‹ch U-Boot cho BeagleBone

### 1ï¸âƒ£ CÃ i Ä‘áº·t cÃ´ng cá»¥ cáº§n thiáº¿t

```bash
# CÃ i Ä‘áº·t cross-compiler
sudo apt-get install gcc-arm-linux-gnueabihf
sudo apt-get install device-tree-compiler
sudo apt-get install u-boot-tools
```

### 2ï¸âƒ£ Táº£i mÃ£ nguá»“n U-Boot

```bash
# Clone U-Boot repository
git clone https://github.com/u-boot/u-boot.git
cd u-boot

# Hoáº·c táº£i phiÃªn báº£n stable
wget https://ftp.denx.de/pub/u-boot/u-boot-2023.10.tar.bz2
tar -xjf u-boot-2023.10.tar.bz2
cd u-boot-2023.10
```

### 3ï¸âƒ£ Cáº¥u hÃ¬nh cho BeagleBone Black

```bash
# Thiáº¿t láº­p cross-compiler
export CROSS_COMPILE=arm-linux-gnueabihf-
export ARCH=arm

# Sá»­ dá»¥ng defconfig cho BeagleBone Black
make am335x_evm_defconfig

# Hoáº·c customize configuration
make menuconfig
```

### 4ï¸âƒ£ BiÃªn dá»‹ch U-Boot

```bash
# BiÃªn dá»‹ch
make -j$(nproc)

# Káº¿t quáº£:
# âœ… MLO (Secondary Program Loader)
# âœ… u-boot.img (U-Boot image)
```

### 5ï¸âƒ£ CÃ i Ä‘áº·t lÃªn SD Card

```bash
# Copy MLO vÃ  u-boot.img vÃ o boot partition
sudo cp MLO /media/boot/
sudo cp u-boot.img /media/boot/

# Sync vÃ  unmount
sync
sudo umount /media/boot
```

---

## âš™ï¸ Biáº¿n mÃ´i trÆ°á»ng U-Boot

U-Boot sá»­ dá»¥ng biáº¿n mÃ´i trÆ°á»ng Ä‘á»ƒ lÆ°u cáº¥u hÃ¬nh. DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c biáº¿n quan trá»ng:

### ğŸ“ CÃ¡c biáº¿n phá»• biáº¿n

| Biáº¿n | MÃ´ táº£ | VÃ­ dá»¥ |
|------|-------|-------|
| `bootargs` | Tham sá»‘ truyá»n cho kernel | `console=ttyO0,115200n8 root=/dev/mmcblk0p2` |
| `bootcmd` | Lá»‡nh thá»±c thi khi boot | `mmc dev 0; fatload mmc 0:1 ...` |
| `bootdelay` | Thá»i gian delay trÆ°á»›c khi auto boot | `3` (seconds) |
| `loadaddr` | Äá»‹a chá»‰ load kernel | `0x82000000` |
| `fdtaddr` | Äá»‹a chá»‰ device tree | `0x88000000` |
| `ipaddr` | IP address cá»§a board | `192.168.1.100` |
| `serverip` | IP cá»§a TFTP server | `192.168.1.10` |

### ğŸ’» Thao tÃ¡c vá»›i biáº¿n mÃ´i trÆ°á»ng

```bash
# In táº¥t cáº£ biáº¿n mÃ´i trÆ°á»ng
U-Boot> printenv

# In má»™t biáº¿n cá»¥ thá»ƒ
U-Boot> printenv bootargs

# Thiáº¿t láº­p biáº¿n
U-Boot> setenv bootargs 'console=ttyO0,115200n8 root=/dev/mmcblk0p2'

# LÆ°u biáº¿n (persistent)
U-Boot> saveenv

# XÃ³a biáº¿n
U-Boot> setenv bootargs
```

---

## ğŸ¯ CÃ¡c lá»‡nh U-Boot thÆ°á»ng dÃ¹ng

### ğŸ” ThÃ´ng tin há»‡ thá»‘ng

```bash
# Hiá»ƒn thá»‹ thÃ´ng tin board
U-Boot> bdinfo

# Hiá»ƒn thá»‹ thÃ´ng tin version
U-Boot> version

# Liá»‡t kÃª cÃ¡c thiáº¿t bá»‹
U-Boot> dm tree
```

### ğŸ’¾ LÃ m viá»‡c vá»›i bá»™ nhá»›

```bash
# Hiá»ƒn thá»‹ ná»™i dung bá»™ nhá»›
U-Boot> md 0x80000000 100

# Ghi vÃ o bá»™ nhá»›
U-Boot> mw 0x80000000 0x12345678 10

# Copy bá»™ nhá»›
U-Boot> cp 0x80000000 0x82000000 100
```

### ğŸ“‚ MMC/SD Card

```bash
# Liá»‡t kÃª cÃ¡c MMC device
U-Boot> mmc list

# Chá»n MMC device
U-Boot> mmc dev 0

# Hiá»ƒn thá»‹ thÃ´ng tin
U-Boot> mmc info

# Äá»c tá»« MMC vÃ o RAM
U-Boot> mmc read 0x82000000 0x800 0x4000

# List files trong FAT partition
U-Boot> fatls mmc 0:1

# Load file tá»« FAT
U-Boot> fatload mmc 0:1 0x82000000 zImage
```

### ğŸŒ Network (TFTP)

```bash
# Thiáº¿t láº­p IP
U-Boot> setenv ipaddr 192.168.1.100
U-Boot> setenv serverip 192.168.1.10

# Download file qua TFTP
U-Boot> tftp 0x82000000 zImage

# Ping server
U-Boot> ping 192.168.1.10
```

---

## ğŸš€ Quy trÃ¬nh Boot Linux

### ğŸ“‹ Boot tá»« SD Card

```bash
# 1. Chá»n MMC device
mmc dev 0

# 2. Load kernel image
fatload mmc 0:1 0x82000000 zImage

# 3. Load device tree
fatload mmc 0:1 0x88000000 am335x-boneblack.dtb

# 4. Thiáº¿t láº­p bootargs
setenv bootargs 'console=ttyO0,115200n8 root=/dev/mmcblk0p2 rw rootwait'

# 5. Boot kernel
bootz 0x82000000 - 0x88000000
```

### ğŸ”„ Táº¡o script tá»± Ä‘á»™ng boot

```bash
# Táº¡o boot script
U-Boot> setenv bootcmd 'mmc dev 0; fatload mmc 0:1 0x82000000 zImage; fatload mmc 0:1 0x88000000 am335x-boneblack.dtb; setenv bootargs console=ttyO0,115200n8 root=/dev/mmcblk0p2 rw rootwait; bootz 0x82000000 - 0x88000000'

# LÆ°u láº¡i
U-Boot> saveenv

# Auto boot sau 3 giÃ¢y
U-Boot> setenv bootdelay 3
U-Boot> saveenv
```

### ğŸ“ Sá»­ dá»¥ng boot.scr

U-Boot cÃ³ thá»ƒ Ä‘á»c script tá»« file `boot.scr`:

**Táº¡o file boot.cmd:**
```bash
echo "ğŸš€ Booting Linux..."
mmc dev 0
fatload mmc 0:1 ${loadaddr} zImage
fatload mmc 0:1 ${fdtaddr} am335x-boneblack.dtb
setenv bootargs 'console=ttyO0,115200n8 root=/dev/mmcblk0p2 rw rootwait'
bootz ${loadaddr} - ${fdtaddr}
```

**Compile sang boot.scr:**
```bash
mkimage -A arm -O linux -T script -C none -a 0 -e 0 -n "Boot Script" -d boot.cmd boot.scr
sudo cp boot.scr /media/boot/
```

---

## ğŸ¨ TÃ¹y chá»‰nh U-Boot

### 1ï¸âƒ£ Thay Ä‘á»•i logo khá»Ÿi Ä‘á»™ng

```c
// include/configs/am335x_evm.h
#define CONFIG_VIDEO_LOGO
#define CONFIG_VIDEO_BMP_LOGO
#define CONFIG_SPLASH_SCREEN
```

### 2ï¸âƒ£ ThÃªm lá»‡nh tÃ¹y chá»‰nh

Táº¡o file `cmd/mycommand.c`:

```c
#include <common.h>
#include <command.h>

static int do_mycommand(cmd_tbl_t *cmdtp, int flag, int argc, char * const argv[])
{
    printf("âœ¨ Hello from custom command!\n");
    return 0;
}

U_BOOT_CMD(
    mycommand, 1, 0, do_mycommand,
    "My custom command",
    "Usage: mycommand\n"
);
```

### 3ï¸âƒ£ Cáº¥u hÃ¬nh Device Tree

U-Boot cÅ©ng cÃ³ device tree riÃªng (`u-boot.dtsi`) Ä‘á»ƒ cáº¥u hÃ¬nh hardware cho bootloader stage.

---

## ğŸ› Debug vÃ  xá»­ lÃ½ lá»—i

### ğŸ” Debug qua UART

```bash
# Káº¿t ná»‘i serial console vá»›i baudrate 115200
screen /dev/ttyUSB0 115200

# Hoáº·c dÃ¹ng minicom
minicom -D /dev/ttyUSB0 -b 115200
```

### âš ï¸ CÃ¡c lá»—i thÆ°á»ng gáº·p

| Lá»—i | NguyÃªn nhÃ¢n | Giáº£i phÃ¡p |
|-----|-------------|-----------|
| `MMC: no card present` | SD card khÃ´ng Ä‘Æ°á»£c phÃ¡t hiá»‡n | Kiá»ƒm tra káº¿t ná»‘i SD card |
| `Bad Linux ARM zImage magic!` | Kernel image bá»‹ lá»—i | Kiá»ƒm tra láº¡i file zImage |
| `FDT not found` | Thiáº¿u device tree | Load Ä‘Ãºng file .dtb |
| `Starting kernel ...` (hang) | Sai bootargs hoáº·c rootfs | Kiá»ƒm tra láº¡i bootargs |

### ğŸ› ï¸ Recovery mode

```bash
# Interrupt auto-boot báº±ng cÃ¡ch nháº¥n phÃ­m báº¥t ká»³
# Sau Ä‘Ã³ reset biáº¿n mÃ´i trÆ°á»ng vá» máº·c Ä‘á»‹nh:
U-Boot> env default -a
U-Boot> saveenv
U-Boot> reset
```

---

## ğŸ“ TÃ i liá»‡u tham kháº£o

- ğŸ“– [U-Boot Documentation](https://docs.u-boot.org/)
- ğŸ”— [U-Boot GitLab](https://source.denx.de/u-boot/u-boot)
- ğŸ“š [BeagleBone U-Boot Guide](https://www.beagleboard.org/docs/)
- ğŸ’¡ [Bootlin U-Boot Training](https://bootlin.com/doc/training/embedded-linux/)

---

## ğŸ“Œ Tá»•ng káº¿t

U-Boot lÃ  má»™t bootloader máº¡nh máº½ vÃ  linh hoáº¡t, Ä‘Ã³ng vai trÃ² quan trá»ng trong viá»‡c khá»Ÿi Ä‘á»™ng há»‡ thá»‘ng nhÃºng Linux. Viá»‡c hiá»ƒu rÃµ cÃ¡ch cáº¥u hÃ¬nh vÃ  sá»­ dá»¥ng U-Boot sáº½ giÃºp báº¡n:

- âœ… TÃ¹y chá»‰nh quÃ¡ trÃ¬nh boot theo nhu cáº§u
- âœ… Debug vÃ  sá»­a lá»—i há»‡ thá»‘ng hiá»‡u quáº£
- âœ… PhÃ¡t triá»ƒn cÃ¡c giáº£i phÃ¡p embedded chuyÃªn nghiá»‡p

HÃ£y thá»±c hÃ nh vá»›i BeagleBone Black Ä‘á»ƒ náº¯m vá»¯ng kiáº¿n thá»©c vá» U-Boot! ğŸš€
